<!doctype html>
<html lang='en'>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><circle cx=%2222%22 cy=%2242%22 r=%228%22 fill=%22%2386efac%22/></svg>"/>

  <style>
  :root{--bg:#f6f7f4;--panel:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0;--brand:#0ea5e9;--accent:#16a34a;--shadow:0 10px 24px rgba(2,6,23,.08)}
  *{box-sizing:border-box}html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border);padding:16px}
  .wrap{max-width:1100px;margin:0 auto;padding:0 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .nav a{color:var(--brand);text-decoration:none;margin-left:12px}
  .footer{max-width:1100px;margin:0 auto;padding:24px 16px;color:var(--muted);text-align:center;border-top:1px solid var(--border)}
  .footer a{color:#0369a1;text-decoration:none;margin:0 6px}
  .section{max-width:1100px;margin:20px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .card2{background:rgba(255,255,255,.9);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .badge{display:inline-block;background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800}
  input,select{border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .btn{background:#0ea5e9;color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer}
  .btn.secondary{background:#1118271a;color:#0f172a}
  .map{height:420px;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
  html, body { min-height: 100%; }
  body {
    background-image: url('/assets/hero_golf_bg.jpg');
    background-size: cover;
    background-position: center 40%;
    background-attachment: fixed;
    background-repeat: no-repeat;
  }
  .muted{color:var(--muted)}
  .hint{margin-top:6px;font-size:13px;color:#6b7280}
  </style>

  <!-- Leaflet (free interactive map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o9N1j8MkfT1TjtGkB2hT0W9n6P2r0YfUStGZ7wZ1Cio="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  ></script>

  <script src="/assets/providers.js"></script>
  <script src="/assets/config.js"></script>
  <title>TeeRadar — Search</title>
</head>
<body>

<header class="header">
  <div class="wrap">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 64 64"><circle cx="22" cy="42" r="8" fill="#86efac"/><rect x="40" y="24" width="4" height="24" fill="#94a3b8"/><path d="M44 24 L60 18 L44 12 Z" fill="#0ea5e9"/></svg>
      <span>TeeRadar</span>
    </div>
    <nav class="nav"><a href="/">Home</a><a href="/book.html">Book</a><a href="/dashboard.html">Dashboard</a><a href="/faq.html">FAQ</a></nav>
  </div>
</header>

<section class='section'>
  <div class='card2' style='display:grid;grid-template-columns:repeat(6,1fr);gap:10px;align-items:end'>
    <div><label>Date<br><input type='date' id='date'></label></div>
    <div><label>Start<br><input type='time' id='timeStart' value='06:00'></label></div>
    <div><label>End<br><input type='time' id='timeEnd' value='17:00'></label></div>
    <div><label>Holes<br><select id='holes'><option value=''>Any</option><option>9</option><option>18</option></select></label></div>
    <div><label>Players<br><select id='party'><option>1</option><option>2</option><option>3</option><option selected>4</option></select></label></div>
    <div><label>Radius<br>
      <select id="radiusKm">
        <option value="">Any distance</option>
        <option value="10">10 km</option>
        <option value="25">25 km</option>
        <option value="50">50 km</option>
        <option value="100">100 km</option>
      </select>
    </label></div>
    <div style='grid-column:1/-1;display:flex;gap:10px'>
      <input id='q' placeholder='Search suburb/course… (defaults to your Home course for radius)' style='flex:1'>
      <button class='btn' id='btnSearch'>Search</button>
    </div>
    <div style="grid-column:1/-1" class="hint" id="homeHint"></div>
  </div>
</section>

<section class='section'><div class='map' id='map'></div></section>
<section class='section'><div id='results' class='grid'></div></section>

<footer class="footer">
  © <script>document.write(new Date().getFullYear())</script> TeeRadar
  • <a href="/faq.html">FAQ</a>
  • <a href="/terms.html">Terms of Use</a>
  • <a href="/privacy.html">Privacy</a>
  • <a href="/refunds.html">Refunds & Cancellations</a>
  • Map data © <a href="https://www.openstreetmap.org/" target="_blank" rel="noopener">OpenStreetMap</a> contributors
</footer>

<script>
/* ---------- Load configs ---------- */
let COURSE_CONFIG_MAP = {}, COURSE_LINKS = {}, isMember = localStorage.getItem('teeradar_member')==='1';
fetch('/assets/course_config.json').then(r=>r.json()).then(j=>COURSE_CONFIG_MAP=j);
fetch('/assets/course_links.json').then(r=>r.json()).then(j=>COURSE_LINKS=j);

/* ---------- Course coordinates (WA + East Coast) ---------- */
const COURSE_COORDS = {
  /* WA */
  'Araluen Estate': { lat: -32.124, lng: 116.099 },
  'Wembley Golf Course (Old & Tuart)': { lat: -31.934, lng: 115.787 },
  'Joondalup Resort Golf Course': { lat: -31.746, lng: 115.766 },
  'Collier Park Golf Course': { lat: -32.007, lng: 115.871 },
  'Whaleback Golf Course': { lat: -32.043, lng: 115.906 },
  'The Vines Resort & Country Club': { lat: -31.777, lng: 116.027 },
  'Maylands Peninsula Golf Course': { lat: -31.942, lng: 115.904 },
  'Glen Iris Golf Course': { lat: -32.099, lng: 115.839 },
  'Hamersley Public Golf Course': { lat: -31.863, lng: 115.761 },
  'Royal Fremantle Golf Club': { lat: -32.048, lng: 115.764 },
  'Cottesloe Golf Club': { lat: -31.988, lng: 115.754 },
  'Melville Glades Golf Club': { lat: -32.056, lng: 115.845 },
  'Sun City Country Club': { lat: -31.646, lng: 115.712 },
  'Secret Harbour Golf Links': { lat: -32.394, lng: 115.762 },
  'Mandurah Country Club': { lat: -32.547, lng: 115.736 },
  'Pinjarra Golf Club': { lat: -32.629, lng: 115.872 },
  'Harvey Golf Club': { lat: -33.083, lng: 115.881 },
  'Bunbury Golf Club': { lat: -33.289, lng: 115.682 },
  'Capel Golf Club': { lat: -33.536, lng: 115.574 },

  /* NSW (sample) */
  'Moore Park Golf': { lat: -33.896, lng: 151.224 },
  'The Coast Golf Club': { lat: -33.969, lng: 151.258 },
  'Long Reef Golf Club': { lat: -33.739, lng: 151.305 },
  'Bonnie Doon Golf Club': { lat: -33.943, lng: 151.214 },

  /* VIC (sample) */
  'Royal Melbourne Golf Club': { lat: -37.959, lng: 145.043 },
  'Sandhurst Club': { lat: -38.069, lng: 145.170 },
  'Sanctuary Lakes Golf Club': { lat: -37.884, lng: 144.748 },
  'Albert Park Golf Course': { lat: -37.850, lng: 144.970 },

  /* QLD (sample) */
  'Brookwater Golf & Country Club': { lat: -27.647, lng: 152.898 },
  'Victoria Park Golf Complex': { lat: -27.446, lng: 153.031 },
  'TPC Twin Waters (Sunshine Coast)': { lat: -26.630, lng: 153.072 },
  'Links Hope Island (Gold Coast)': { lat: -27.877, lng: 153.354 }
};

/* ---------- Leaflet map ---------- */
let map, markersLayer, radiusCircle;
function initMap(center) {
  if (!map) {
    map = L.map('map', { scrollWheelZoom: true }).setView(center || [-31.95, 115.86], 10); // Perth default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  } else if (center) {
    map.setView(center, 12);
  }
}

/* ---------- Profile helpers ---------- */
function loadProfile(){
  try { return JSON.parse(localStorage.getItem('teeradar_profile')||'{}'); }
  catch(e){ return {}; }
}
function getHomeCenter(){
  const p = loadProfile();
  if (p && p.homeCourse && COURSE_COORDS[p.homeCourse]) {
    return [COURSE_COORDS[p.homeCourse].lat, COURSE_COORDS[p.homeCourse].lng];
  }
  return null;
}

/* ---------- UI helpers ---------- */
function officialUrlOrSearch(name){
  return COURSE_LINKS[name] || ('https://www.google.com/search?q='+encodeURIComponent(name+' golf booking'));
}
function openCourseForMembers(url){
  if(!isMember){ alert('Members only. Subscribe to unlock direct booking links.'); return; }
  window.open(url,'_blank','noopener,noreferrer');
}
function courseCard(it){
  var html = '';
  html += "<div class='card2'>";
  html += "<div class='badge'>" + (it.provider||'Course') + "</div>";
  html += "<h3 style='margin:8px 0 4px 0'>" + it.name + "</h3>";
  html += "<div style='color:var(--muted);font-size:14px'>" + (it.city||'') + " " + (it.state||'') + "</div>";
  html += "<div class='price' style='font-weight:800;margin:8px 0'>$" + (it.price||49).toFixed(2) + " AUD</div>";
  html += "<div style='display:flex;gap:8px'>";
  html += "<button class='btn secondary' onclick=\"openCourseForMembers(officialUrlOrSearch('"+'__NAME__'+"'))\">Book on course site</button>".replace('__NAME__', it.name.replace(/"/g,'\\"'));
  html += "<button class='btn' onclick=\"(function(){ var d=document.getElementById('date').value||''; var u=TeeRadarProviders.proceedUrl('"+'__NAME2__'+"', d, it.time, COURSE_CONFIG_MAP, officialUrlOrSearch); openCourseForMembers(u); })()\">Proceed to booking</button>".replace('__NAME2__', it.name.replace(/"/g,'\\"'));
  html += "</div></div>";
  return html;
}

/* ---------- Distance / radius ---------- */
function toLatLng(obj){ return [obj.lat, obj.lng]; }
function distanceKm(a,b){
  const toRad = x => x*Math.PI/180;
  const R=6371, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const la1=toRad(a.lat), la2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
function centerFromQuery(q){
  if(!q) return null;
  const keys = Object.keys(COURSE_COORDS);
  const lower = q.toLowerCase();
  let hit = keys.find(k => k.toLowerCase() === lower) || keys.find(k => k.toLowerCase().includes(lower));
  return hit ? COURSE_COORDS[hit] : null;
}

/* ---------- Map plotting ---------- */
function plotCourses(list){
  markersLayer.clearLayers();
  const pts = [];
  list.forEach(it=>{
    const c = COURSE_COORDS[it.name];
    if(!c) return;
    const m = L.marker([c.lat, c.lng]).addTo(markersLayer);
    m.bindPopup(
      `<strong>${it.name}</strong>`
      + (it.provider ? `<br>${it.provider}` : '')
      + (it.time ? `<br>Time: ${it.time}` : '')
      + (it.holes ? `<br>Holes: ${it.holes}` : '')
    );
    pts.push([c.lat, c.lng]);
  });
  if (pts.length === 1) map.setView(pts[0], 13);
  else if (pts.length > 1) map.fitBounds(pts, { padding: [24,24] });
}

/* ---------- Rendering ---------- */
function render(list){
  document.getElementById('results').innerHTML = list.map(courseCard).join('');
  plotCourses(list);
}

/* ---------- Demo + Live search ---------- */
const TODAY = new Date().toISOString().slice(0,10);
const demoData = [
  {name:'Araluen Estate', provider:'MiClub', city:'Roleystone', state:'WA', postcode:'6111', date:TODAY, time:'07:00', holes:18, spots:4, price:65},
  {name:'Wembley Golf Course (Old & Tuart)', provider:'MiClub', city:'Wembley Downs', state:'WA', postcode:'6019', date:TODAY, time:'09:15', holes:9, spots:2, price:52},
  {name:'Joondalup Resort Golf Course', provider:'MiClub', city:'Joondalup', state:'WA', time:'08:20', holes:18, spots:4, price:89},
  {name:'Collier Park Golf Course', provider:'MiClub', city:'Como', state:'WA', time:'10:15', holes:9, spots:2, price:35},
  /* East-coast samples */
  {name:'Moore Park Golf', provider:'Lightspeed', city:'Sydney', state:'NSW', time:'09:00', holes:18, spots:4, price:65},
  {name:'Royal Melbourne Golf Club', provider:'(Private)', city:'Black Rock', state:'VIC', time:'—', holes:18, spots:0, price:0},
  {name:'Victoria Park Golf Complex', provider:'Lightspeed', city:'Brisbane', state:'QLD', time:'13:20', holes:9, spots:2, price:32}
];

function runDemoSearch(){
  const date=document.getElementById('date').value;
  const s=document.getElementById('timeStart').value, e=document.getElementById('timeEnd').value;
  const holes=document.getElementById('holes').value; const party=parseInt(document.getElementById('party').value||'0',10);
  const q=(document.getElementById('q').value||'').toLowerCase().trim();
  const radiusVal=document.getElementById('radiusKm').value;
  const radiusKm = radiusVal ? parseFloat(radiusVal) : NaN;

  let out=demoData.filter(function(it){
    const inQ=!q||(it.name+' '+(it.city||'')+' '+(it.state||'')+' '+(it.postcode||'')).toLowerCase().includes(q);
    const inDate=!date||it.date===date;
    const inHoles=!holes||String(it.holes)===holes;
    const inTime=(!s||it.time>=s)&&(!e||it.time<=e);
    const inParty=!party||it.spots>=party;
    return inQ&&inDate&&inHoles&&inTime&&inParty;
  });

  // radius handling: prefer query center; else home course
  if(!isNaN(radiusKm)){
    const queryCenter = centerFromQuery(q);
    const homeArr = getHomeCenter();
    const homeCenter = homeArr ? {lat:homeArr[0], lng:homeArr[1]} : null;
    const center = queryCenter || homeCenter;
    const hint = document.getElementById('homeHint');

    if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }

    if(center){
      // visual radius circle
      radiusCircle = L.circle([center.lat, center.lng], {
        radius: radiusKm * 1000,
        weight: 1, fillOpacity: 0.06
      }).addTo(map);
      map.fitBounds(radiusCircle.getBounds(), { padding:[20,20] });

      out = out.filter(it=>{
        const coord = COURSE_COORDS[it.name];
        if(!coord) return false;
        return distanceKm(center, coord) <= radiusKm;
      });

      if (queryCenter) {
        hint.textContent = `Radius ${radiusKm} km from: ${Object.keys(COURSE_COORDS).find(k=>COURSE_COORDS[k]===queryCenter) || 'your search'}.`;
      } else if (homeCenter) {
        // try to get the name
        const p = loadProfile();
        hint.textContent = `Radius ${radiusKm} km from your Home course: ${p.homeCourse}.`;
      }
    } else {
      hint.textContent = 'Tip: set a Home course in Dashboard or type a known course name to use radius.';
    }
  } else {
    document.getElementById('homeHint').textContent = '';
    if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
  }

  render(out);
}

async function runLiveSearch(){
  const base = window.TEERADAR_BACKEND || '';
  const body = {
    date: document.getElementById('date').value || TODAY,
    earliest: document.getElementById('timeStart').value || '06:00',
    latest: document.getElementById('timeEnd').value || '17:00',
    holes: document.getElementById('holes').value || null,
    partySize: parseInt(document.getElementById('party').value||'0',10) || 1
  };
  const r = await fetch((base||'') + '/api/search', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok) throw new Error('search failed '+r.status);
  const j = await r.json();
  const list = (j.slots||[]).map(function(s){
    return { name: s.name, provider: s.provider, city:'', state:'', time: s.time, holes: s.holes, spots: s.spots, price: s.price };
  });
  render(list);
}

/* ---------- Init ---------- */
document.getElementById('btnSearch').addEventListener('click', async function(){
  try { await runLiveSearch(); }
  catch(e){ console.warn('Live search failed, falling back to demo', e); runDemoSearch(); }
});

(function initialLoad(){
  // center map on Home course if set
  const hc = getHomeCenter();
  initMap(hc || [-31.95,115.86]);
  // show hint if home course exists
  const p = loadProfile();
  if (p && p.homeCourse && COURSE_COORDS[p.homeCourse]) {
    document.getElementById('homeHint').textContent = `Map centered on your Home course: ${p.homeCourse}.`;
  }
})();
</script>

</body>
</html>

