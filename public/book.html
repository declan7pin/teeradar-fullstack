<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar — Book a Tee Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google AdSense (auto ads) -->
  <script
    async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7954721781460856"
    crossorigin="anonymous">
  </script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root {
      --teal: #006b57;
      --teal-dark: #004e40;
      --green: #00c853;
      --red: #d50000;
      --purple: #7e57c2;
      --yellow: #f9a825;
      --bg: #f4f4f4;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: #222;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--teal);
      color: #fff;
    }

    .top-bar-title { font-weight: 600; }

    .top-bar button {
      border: none;
      background: #fff;
      color: var(--teal);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }

    .filters {
      background: #fff;
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .filter-group {
      flex: 1 1 140px;
      min-width: 0;
    }

    .filter-label {
      font-size: 12px;
      color: #555;
      margin-bottom: 2px;
    }

    .filter-control {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .search-btn {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      background: var(--teal);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
    }

    .status-line {
      font-size: 13px;
      padding: 6px 16px 0 16px;
      color: #555;
    }

    #map {
      height: 320px;
      margin: 10px 16px;
      border-radius: 12px;
      overflow: hidden;
      background: #ddd;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      padding: 0 16px 6px 16px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.25);
    }

    .dot-green { background: var(--green); }
    .dot-red { background: var(--red); }
    .dot-purple { background: var(--purple); }
    .dot-yellow { background: var(--yellow); }

    .courses-strip {
      padding: 8px 12px 16px 12px;
      overflow-x: auto;
      display: flex;
      gap: 10px;
    }

    .course-card {
      min-width: 260px;
      max-width: 280px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .course-header {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .course-sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: #f1f1f1;
      color: #444;
    }

    .chip-provider {
      background: #eef7ff;
      color: #0b63ce;
    }

    .chip-availability-green {
      background: #e6f9ef;
      color: #1b7d45;
    }

    .chip-availability-red {
      background: #ffeaea;
      color: #b03030;
    }

    .chip-availability-purple {
      background: #f3e8ff;
      color: #673ab7;
    }

    .chip-availability-yellow {
      background: #fff8e1;
      color: #996600;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .booking-link {
      color: #0059ff;
      font-weight: 600;
      cursor: pointer;
    }

    .booking-link[aria-disabled="true"] {
      color: #999;
      cursor: default;
    }

    .marker-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4);
    }

    .marker-green { background: var(--green); }
    .marker-red { background: var(--red); }
    .marker-purple { background: var(--purple); }
    .marker-yellow { background: var(--yellow); }

    @media (min-width: 800px) {
      #map { height: 380px; }
      .courses-strip { flex-wrap: wrap; overflow-x: visible; }
      .course-card { flex: 0 0 calc(33.33% - 12px); }
    }
  </style>
</head>

<body>
  <header class="top-bar">
    <div class="top-bar-title">TeeRadar — Book a Tee Time</div>
    <button onclick="window.location.href='index.html'">Return Home</button>
  </header>

  <section class="filters">
    <div class="filters-row">
      <div class="filter-group">
        <div class="filter-label">State</div>
        <select id="stateSelect" class="filter-control">
          <option value="ALL">All states</option>
          <option value="WA">WA</option>
          <option value="NSW">NSW</option>
          <option value="VIC">VIC</option>
          <option value="QLD">QLD</option>
          <option value="SA">SA</option>
          <option value="TAS">TAS</option>
          <option value="ACT">ACT</option>
          <option value="NT">NT</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Date</div>
        <input id="date" class="filter-control" type="date" />
      </div>
      <div class="filter-group">
        <div class="filter-label">Earliest</div>
        <input id="earliest" class="filter-control" type="time" value="06:00" />
      </div>
      <div class="filter-group">
        <div class="filter-label">Latest</div>
        <input id="latest" class="filter-control" type="time" value="17:00" />
      </div>
      <div class="filter-group">
        <div class="filter-label">Holes</div>
        <select id="holes" class="filter-control">
          <option value="9">9 holes</option>
          <option value="18">18 holes</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Players</div>
        <select id="players" class="filter-control">
          <option value="1">1 player</option>
          <option value="2">2 players</option>
          <option value="3" selected>3 players</option>
          <option value="4">4 players</option>
        </select>
      </div>
    </div>
    <button class="search-btn" onclick="runSearch()">Search availability</button>
  </section>

  <div class="status-line" id="status-line">
    <!-- Filled by JS to include state -->
  </div>

  <div id="map"></div>

  <div class="legend">
    <div class="legend-item">
      <span class="legend-dot dot-green"></span> Available
    </div>
    <div class="legend-item">
      <span class="legend-dot dot-red"></span> Not available
    </div>
    <div class="legend-item">
      <span class="legend-dot dot-purple"></span> Phone booking
    </div>
    <div class="legend-item">
      <span class="legend-dot dot-yellow"></span> Unable to confirm availability
    </div>
  </div>

  <section class="courses-strip" id="courses-strip"></section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---- STATE HANDLING (shared with index) ----
    const STATE_KEY = "teeradar_state";
    const DEFAULT_STATE = "WA";
    const VALID_STATES = ["ALL","WA","NSW","VIC","QLD","SA","TAS","ACT","NT"];

    function getCurrentState() {
      const saved = localStorage.getItem(STATE_KEY);
      if (VALID_STATES.includes(saved)) return saved;
      return DEFAULT_STATE;
    }

    function setCurrentState(code) {
      const value = VALID_STATES.includes(code) ? code : DEFAULT_STATE;
      localStorage.setItem(STATE_KEY, value);
    }

    function getStateLabel(code) {
      switch (code) {
        case "WA": return "Western Australia";
        case "NSW": return "New South Wales";
        case "VIC": return "Victoria";
        case "QLD": return "Queensland";
        case "SA": return "South Australia";
        case "TAS": return "Tasmania";
        case "ACT": return "Australian Capital Territory";
        case "NT": return "Northern Territory";
        case "ALL": return "all states in Australia";
        default: return "Australia";
      }
    }

    function getMapViewForState(code) {
      switch (code) {
        case "ALL":
          return { center: [-25.0, 133.0], zoom: 4.5 };
        case "NSW":
          return { center: [-33.87, 151.21], zoom: 6 };
        case "VIC":
          return { center: [-37.81, 144.96], zoom: 6 };
        case "QLD":
          return { center: [-27.47, 153.02], zoom: 5.8 };
        case "SA":
          return { center: [-34.93, 138.60], zoom: 6 };
        case "TAS":
          return { center: [-42.88, 147.32], zoom: 6 };
        case "ACT":
          return { center: [-35.28, 149.13], zoom: 7 };
        case "NT":
          return { center: [-12.46, 130.84], zoom: 6 };
        case "WA":
        default:
          return { center: [-31.95, 115.86], zoom: 5.8 };
      }
    }

    function resetMapViewForState(stateCode) {
      if (!map) return;
      const view = getMapViewForState(stateCode || getCurrentState());
      map.setView(view.center, view.zoom);
    }

    function updateStatusLineIdle() {
      const state = getCurrentState();
      const label = getStateLabel(state);
      statusLine.textContent =
        `Searching courses in ${label}. Tap "Search availability" to check live times.`;
      statusLine.style.color = "#555";
    }

    function initStateSelector() {
      const select = document.getElementById("stateSelect");
      if (!select) return;

      const current = getCurrentState();
      select.value = VALID_STATES.includes(current) ? current : DEFAULT_STATE;

      select.addEventListener("change", () => {
        const value = select.value;
        setCurrentState(value);
        resetMapViewForState(value);
        updateStatusLineIdle();
        // If there's already a search, re-run it for the new state
        if (lastSearchCriteria) {
          runSearch();
        } else {
          groupedSlots = {};
          renderCourses();
        }
      });

      updateStatusLineIdle();
    }

    // ---- ANALYTICS (re-using your backend endpoint) ----
    function trackEvent(type, payload) {
      try {
        fetch("/api/analytics/event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type,
            payload: payload || {},
            at: new Date().toISOString()
          })
        }).catch(() => {});
      } catch (e) {
        console.warn("analytics event failed", e);
      }
    }

    let map;
    let markers = [];
    let courses = [];
    let lastSearchCriteria = null; // { date, earliest, latest, holes, partySize, state }
    let groupedSlots = {};         // courseName => [slots]

    const statusLine = document.getElementById("status-line");
    const coursesStrip = document.getElementById("courses-strip");

    init();

    async function init() {
      initMap();
      await loadCourses();
      applyHomeCourseZoom();
      initStateSelector();
      renderCourses();
      trackEvent("book_view", { state: getCurrentState() });
    }

    function initMap() {
      const view = getMapViewForState(getCurrentState());
      map = L.map("map").setView(view.center, view.zoom);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);
    }

    async function loadCourses() {
      try {
        const res = await fetch("/api/courses");
        courses = await res.json();
      } catch (err) {
        console.error("Failed to load courses", err);
        courses = [];
      }
    }

    // ---- HOME COURSE ZOOM LOGIC ----

    function getHomeCourseName() {
      // Set elsewhere on login: localStorage.setItem("teeradar_home_course", courseName)
      return localStorage.getItem("teeradar_home_course") || null;
    }

    function applyHomeCourseZoom() {
      if (!map || !Array.isArray(courses) || courses.length === 0) return;

      const homeName = getHomeCourseName();
      if (!homeName) return;

      const target = homeName.toLowerCase().trim();
      if (!target) return;

      let bestMatch = null;

      for (const c of courses) {
        if (!c) continue;
        if (typeof c.lat !== "number" || typeof c.lng !== "number") continue;

        const cname = String(c.name || "").toLowerCase();
        if (!cname) continue;

        // Exact or strong contains match
        if (cname === target || cname.includes(target)) {
          bestMatch = c;
          break;
        }

        // Fallback: compare base names (before any "(")
        if (!bestMatch) {
          const baseTarget = target.split("(")[0].trim();
          if (baseTarget && cname.includes(baseTarget)) {
            bestMatch = c;
          }
        }
      }

      if (bestMatch) {
        map.setView([bestMatch.lat, bestMatch.lng], 10);
      }
    }

    // ---- SEARCH & RENDER ----

    async function runSearch() {
      const date = document.getElementById("date").value;
      const earliest = document.getElementById("earliest").value || "06:00";
      const latest = document.getElementById("latest").value || "17:00";
      const holes = document.getElementById("holes").value;
      const players = document.getElementById("players").value;
      const state = getCurrentState();

      if (!date) {
        alert("Please select a date.");
        return;
      }

      lastSearchCriteria = {
        date,
        earliest,
        latest,
        holes,
        partySize: Number(players) || 1,
        state
      };

      window.teeRadarLastSearchDate = date;

      statusLine.textContent = "Checking live availability...";
      statusLine.style.color = "#555";

      trackEvent("search_run", lastSearchCriteria);

      try {
        const res = await fetch("/api/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(lastSearchCriteria),
        });

        const data = await res.json();
        const slots = Array.isArray(data.slots) ? data.slots : [];

        groupedSlots = {};
        slots.forEach((s) => {
          const name = s.course || s.courseName || s.courseTitle || s.course_name;
          if (!name) return;
          if (!groupedSlots[name]) groupedSlots[name] = [];
          groupedSlots[name].push(s);
        });

        const selectedHoles = Number(holes);
        const selectedState = state;
        let availableCourses = 0;
        let totalSlots = 0;

        Object.entries(groupedSlots).forEach(([courseName, cSlots]) => {
          const course = courses.find((c) => c.name === courseName);
          if (!course) return;

          const courseState = course.state || "WA";
          if (selectedState !== "ALL" && courseState !== selectedState) {
            return;
          }

          const provider = course.provider || "Other";
          const isPhone = provider === "Phone";

          // Hole filter applies only to non-phone courses
          if (
            !isPhone &&
            selectedHoles &&
            typeof course.holes === "number" &&
            Number(course.holes) !== selectedHoles
          ) {
            return;
          }

          availableCourses++;
          totalSlots += cSlots.length;
        });

        if (totalSlots === 0) {
          statusLine.textContent =
            "No matching tee times found in that window. Try adjusting the filters.";
          statusLine.style.color = "#b03030";
        } else {
          statusLine.textContent =
            `Updated. ${availableCourses} courses have availability (${totalSlots} slots). ` +
            "Tap a course to view live times on the official booking site.";
          statusLine.style.color = "#1b7d45";
        }

        renderCourses();
      } catch (err) {
        console.error("Search error", err);
        statusLine.textContent = "Error checking availability. Please try again.";
        statusLine.style.color = "#b03030";
      }
    }

    function clearMarkers() {
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
    }

    function createMarkerIcon(kind) {
      let className = "marker-dot marker-red";
      if (kind === "available") className = "marker-dot marker-green";
      if (kind === "phone") className = "marker-dot marker-purple";
      if (kind === "unknown") className = "marker-dot marker-yellow";
      return L.divIcon({ className, iconSize: [14, 14] });
    }

    function renderCourses() {
      clearMarkers();
      coursesStrip.innerHTML = "";

      const selectedHoles = Number(
        (lastSearchCriteria && lastSearchCriteria.holes) ||
        document.getElementById("holes").value ||
        0
      );

      const selectedState = getCurrentState();

      const filteredCourses = courses.filter((course) => {
        const courseState = course.state || "WA";
        if (selectedState === "ALL") return true;
        return courseState === selectedState;
      });

      filteredCourses.forEach((course) => {
        const name = course.name;
        const provider = course.provider || "Other";
        const isPhone = provider === "Phone";

        const courseStateCode = course.state || "WA";
        const courseStateLabel = getStateLabel(courseStateCode);

        // Wembley & Meadow Springs → unable to confirm (yellow)
        const isUnconfirmed =
          name.startsWith("Wembley Golf Course") ||
          name.startsWith("Meadow Springs Golf Course") ||
          name.startsWith("Meadow Springs Golf & Country Club");

        // Hole filter: hide non-matching *except* phone-booking courses
        if (
          !isPhone &&
          selectedHoles &&
          typeof course.holes === "number" &&
          Number(course.holes) !== selectedHoles
        ) {
          return;
        }

        const slots = groupedSlots[name] || [];
        const hasSlots = slots.length > 0;

        let markerKind = "unavailable";
        if (isPhone) markerKind = "phone";
        else if (isUnconfirmed) markerKind = "unknown";
        else if (hasSlots) markerKind = "available";

        if (typeof course.lat === "number" && typeof course.lng === "number") {
          const marker = L.marker([course.lat, course.lng], {
            icon: createMarkerIcon(markerKind),
          }).addTo(map);

          let popupHtml = `<div style="font-size:13px;">
            <strong>${name}</strong><br>${provider}`;

          if (isUnconfirmed) {
            popupHtml += `<br><strong>Unable to confirm availability</strong>`;
          } else if (hasSlots) {
            popupHtml += `<br>${slots.length} slots`;
          } else if (isPhone) {
            popupHtml += `<br>Phone booking`;
            if (course.phone) {
              popupHtml += `<br><strong>${course.phone}</strong>`;
            }
          }

          if (!isPhone) {
            popupHtml += `<br><span
              class="booking-link"
              role="button"
              data-course-name="${encodeURIComponent(name)}"
              style="display:inline-block;margin-top:4px;"
            >Go to booking</span>`;
          }

          popupHtml += `</div>`;

          marker.bindPopup(popupHtml);
          markers.push(marker);
        }

        const card = document.createElement("article");
        card.className = "course-card";

        const holesLabel =
          course.holes === 9 ? "9 holes" :
          course.holes === 18 ? "18 holes" :
          `${course.holes} holes`;

        let availChipClass = "chip-availability-red";
        let availLabel = "No availability";
        if (isPhone) {
          availChipClass = "chip-availability-purple";
          availLabel = "Phone booking";
        } else if (isUnconfirmed) {
          availChipClass = "chip-availability-yellow";
          availLabel = "Unable to confirm availability";
        } else if (hasSlots) {
          availChipClass = "chip-availability-green";
          availLabel = "Available";
        }

        const providerLabel =
          provider === "MiClub"
            ? "MiClub • live check"
            : provider === "Quick18"
            ? "Quick18 • live check"
            : provider === "Phone"
            ? "Phone booking"
            : provider;

        const phoneText = isPhone && course.phone ? course.phone : "";

        card.innerHTML = `
          <div>
            <div class="course-header">${name}</div>
            <div class="course-sub">${courseStateLabel}</div>
            <div class="chip-row">
              <span class="chip chip-provider">${providerLabel}</span>
              <span class="chip ${availChipClass}">${availLabel}</span>
              <span class="chip">${holesLabel}</span>
            </div>
          </div>
          <div class="card-footer">
            <span>${
              isUnconfirmed
                ? "Check course site"
                : hasSlots
                ? slots.length + " slots"
                : phoneText
            }</span>
            ${
              isPhone
                ? ""
                : `<span class="booking-link"
                         role="button"
                         data-course-name="${encodeURIComponent(name)}"
                         aria-disabled="${hasSlots || isUnconfirmed ? "false" : "true"}">
                      Go to booking
                   </span>`
            }
          </div>
        `;

        coursesStrip.appendChild(card);
      });

      // If no courses at all in this state, show a friendly message
      if (filteredCourses.length === 0) {
        const msg = document.createElement("div");
        msg.style.fontSize = "13px";
        msg.style.color = "#666";
        msg.textContent = "No courses configured for this state yet.";
        coursesStrip.appendChild(msg);
      }
    }

    document.addEventListener("click", (evt) => {
      const el = evt.target.closest(".booking-link");
      if (!el) return;

      const disabled = el.getAttribute("aria-disabled") === "true";
      if (disabled) return;

      const courseNameEncoded = el.dataset.courseName;
      if (!courseNameEncoded) return;

      const courseName = decodeURIComponent(courseNameEncoded);
      const course = courses.find((c) => c.name === courseName);
      if (!course) return;

      const provider = course.provider || "MiClub";
      const slots = groupedSlots[courseName] || [];
      const exampleSlot = slots[0] || {};
      const searchDate =
        (lastSearchCriteria && lastSearchCriteria.date) ||
        window.teeRadarLastSearchDate;

      let baseUrl =
        exampleSlot.bookingUrl ||
        exampleSlot.url ||
        course.url ||
        "";

      if (!baseUrl) return;

      let finalUrl = baseUrl;

      try {
        const u = new URL(baseUrl);

        if (provider === "MiClub") {
          if (searchDate) u.searchParams.set("selectedDate", searchDate);
          u.searchParams.delete("recaptchaResponse");
          u.searchParams.delete("mobile");
          finalUrl = u.toString();
        } else if (provider === "Quick18") {
          if (searchDate) {
            const yyyymmdd = searchDate.replace(/-/g, "");
            u.searchParams.set("teedate", yyyymmdd);
          }
          finalUrl = u.toString();
        }
      } catch (err) {
        console.error("Error building booking URL:", err);
      }

      window.open(finalUrl, "_blank");
    });

    (function setDefaultDate() {
      const input = document.getElementById("date");
      if (!input) return;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      input.value = `${yyyy}-${mm}-${dd}`;
    })();
  </script>
</body>
</html>