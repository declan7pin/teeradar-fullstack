<!doctype html>
<html lang='en'>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeeRadar — Book a Tee Time</title>
  <link rel="stylesheet" href="/assets/leaflet.css">
  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#f6f7f4; }
    header { background:#fff; border-bottom:1px solid #e2e8f0; padding:14px 16px; display:flex; justify-content:space-between; align-items:center; }
    header nav a { margin-left:12px; text-decoration:none; color:#0ea5e9; font-weight:600; }
    .top-bar { max-width:1100px; margin:16px auto; background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .top-bar label { font-size:13px; color:#475569; display:flex; flex-direction:column; gap:4px; }
    .top-bar input,.top-bar select { padding:6px 8px; border:1px solid #e2e8f0; border-radius:8px; }
    .btn { background:#0ea5e9; color:#fff; border:none; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; height:fit-content; align-self:flex-end; }
    #map { height:420px; max-width:1100px; margin:0 auto 18px auto; border-radius:14px; overflow:hidden; border:1px solid #e2e8f0; }
    #results { max-width:1100px; margin:0 auto 32px auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:12px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:12px; }
  </style>
</head>
<body>
<header>
  <div style="font-weight:800;display:flex;gap:8px;align-items:center"><span>TeeRadar</span></div>
  <nav><a href="/">Home</a><a href="/book.html">Book</a><a href="/dashboard.html">Dashboard</a><a href="/faq.html">FAQ</a></nav>
</header>

<div class="top-bar">
  <label>Search course / suburb
    <input type="text" id="q" placeholder="Search Australia-wide…">
  </label>
  <label>Radius
    <select id="radiusKm">
      <option value="">Any</option>
      <option value="10">10 km</option>
      <option value="25">25 km</option>
      <option value="50">50 km</option>
      <option value="100">100 km</option>
    </select>
  </label>
  <button class="btn" id="btnSearch">Search</button>
</div>

<div id="map"></div>
<div id="results"></div>

<script src="/assets/leaflet.js"></script>
<script>
  let map, markersLayer;
  let COURSES = [];

  // Blue for available, red for unavailable
  const blueIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    shadowSize: [41, 41]
  });
  const redIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x-red.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    shadowSize: [41, 41]
  });

  function initMap(center){
    if(!map){
      map = L.map('map').setView(center || [-24.0, 133.0], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    } else if (center){
      map.setView(center, 11);
    }
  }

  async function loadCourses(){
    const r = await fetch('/assets/courses.json');
    COURSES = await r.json();
  }

  function openCourse(name){
    const url = 'https://www.google.com/search?q=' + encodeURIComponent(name + ' golf booking');
    window.open(url, '_blank', 'noopener,noreferrer');
  }

  function renderCourses(list){
    const results = document.getElementById('results');
    results.innerHTML = '';
    list.forEach(c=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div style="font-weight:700">${c.name}</div>
        <div style="color:#64748b;font-size:13px">${c.city || ''} ${c.state || ''}</div>
        <div style="margin-top:4px;font-size:13px;color:${c.available === false ? '#b91c1c' : '#15803d'}">
          ${c.availability || 'Availability: unknown'}
        </div>
        <button style="margin-top:6px" onclick="openCourse('${c.name.replace(/'/g, "\'")}')">Proceed to booking</button>
      `;
      results.appendChild(div);
    });
  }

  function plotMarkers(list){
    markersLayer.clearLayers();
    const bounds = [];
    list.forEach(c=>{
      if(c.lat == null || c.lng == null) return;
      const icon = (c.available === false) ? redIcon : blueIcon;
      const m = L.marker([c.lat, c.lng], { icon }).addTo(markersLayer);
      m.bindPopup(`
        <strong>${c.name}</strong><br>
        ${c.city || ''} ${c.state || ''}<br>
        <span style="color:${c.available === false ? '#b91c1c' : '#15803d'}">
          ${c.availability || 'Availability: unknown'}
        </span><br>
        <button onclick="openCourse('${c.name.replace(/'/g, "\'")}')" style="margin-top:4px">Book</button>
      `);
      bounds.push([c.lat, c.lng]);
    });
    if(bounds.length > 1){
      map.fitBounds(bounds, { padding:[24,24] });
    }
  }

  function distKm(a,b){
    const toRad = x => x*Math.PI/180;
    const R = 6371;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const la1 = toRad(a.lat);
    const la2 = toRad(b.lat);
    const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)**2;
    return 2 * R * Math.asin(Math.sqrt(h));
  }

  function centerFromQuery(q){
    if(!q) return null;
    const lower = q.toLowerCase();
    const hit = COURSES.find(c => (c.name + ' ' + (c.city||'')).toLowerCase().includes(lower));
    return hit ? { lat: hit.lat, lng: hit.lng } : null;
  }

  function runSearch(){
    const q = (document.getElementById('q').value || '').toLowerCase().trim();
    const radiusVal = document.getElementById('radiusKm').value;
    const radiusKm = radiusVal ? parseFloat(radiusVal) : NaN;

    let out = COURSES.filter(c=>{
      const text = (c.name + ' ' + (c.city||'') + ' ' + (c.state||'')).toLowerCase();
      return !q || text.includes(q);
    });

    if(!isNaN(radiusKm)){
      const center = centerFromQuery(q);
      if(center){
        out = out.filter(c => c.lat != null && c.lng != null && distKm(center, c) <= radiusKm);
        map.setView([center.lat, center.lng], 9);
      }
    }

    renderCourses(out);
    plotMarkers(out);
  }

  (async function(){
    await loadCourses();
    initMap();
    plotMarkers(COURSES);
    renderCourses(COURSES);
  })();

  document.getElementById('btnSearch').addEventListener('click', runSearch);
</script>
</body>
</html>
