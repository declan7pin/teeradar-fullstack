<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar — WA Realtime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/assets/leaflet.css" />
  <style>
    :root { --teal:#036b65; --bg:#eef3f1; --card:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg)}
    header{background:var(--teal);color:#fff;padding:10px 4vw;display:flex;align-items:center;justify-content:space-between}
    .home-btn{background:#fff;color:var(--teal);border:none;padding:6px 16px;border-radius:999px;font-weight:600;cursor:pointer}
    .filters{background:#fff;padding:14px 4vw;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border-bottom:1px solid rgba(0,0,0,.05)}
    .filters input,.filters select{border:1px solid #d1d5db;border-radius:8px;padding:7px 10px;background:#fff}
    .filters button{background:var(--teal);color:#fff;border:none;border-radius:10px;padding:8px 15px;font-weight:600;cursor:pointer}
    #status{font-size:.78rem;padding:5px 4vw;color:#475569}
    #map{height:420px;margin:0 4vw;border-radius:16px;overflow:hidden;background:#cbd5f5}
    .course-strip{margin:16px 4vw 20px;display:flex;gap:14px;overflow-x:auto;padding-bottom:10px}
    .course-card{min-width:240px;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.05);box-shadow:0 8px 20px rgba(15,23,42,.04);padding:12px 12px 14px;flex:0 0 auto}
    .badge{display:inline-block;padding:3px 9px;border-radius:999px;font-size:.6rem;margin-bottom:6px;background:#e2e8f0}
    .btn-small{background:#eef3f1;border:none;border-radius:10px;padding:6px 10px;font-size:.65rem;cursor:pointer;margin-top:6px}
    @media (max-width:900px){#map{height:55vh;margin:0 2vw}.filters{padding:12px 2vw}.course-strip{margin:16px 2vw 20px}}
  </style>
  <script src="/assets/leaflet.js"></script>
</head>
<body>
  <header>
    <div style="font-weight:700;">TeeRadar WA — Realtime</div>
    <button class="home-btn" onclick="window.location.href='/'">Return Home</button>
  </header>

  <div class="filters">
    <input type="date" id="date" />
    <input type="time" id="timeStart" value="06:00" />
    <input type="time" id="timeEnd" value="17:00" />
    <select id="holes">
      <option value="">Any holes</option>
      <option value="9">9 holes</option>
      <option value="18">18 holes</option>
    </select>
    <select id="players">
      <option value="1">1 Player</option>
      <option value="2">2 Players</option>
      <option value="3">3 Players</option>
      <option value="4" selected>4 Players</option>
    </select>
    <button id="searchBtn">Search Availability</button>
  </div>

  <div id="status">Ready.</div>
  <div id="map"></div>
  <div class="course-strip" id="courseStrip"></div>

  <script>
    let map, markersLayer, courseList = [];

    function initMap(){
      map = L.map("map").setView([-31.95, 115.86], 9);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function markerStyle(color){
      return {radius:7, fillColor:color, color:"#fff", weight:1, fillOpacity:.9};
    }

    function renderMarkers(resultsByName = {}){
      markersLayer.clearLayers();
      courseList.forEach(c => {
        const key = (c.name||"").toLowerCase();
        const match = resultsByName[key];
        let color = "#ef4444";            // red = default unavailable
        if (c.phoneOnly) color = "#a855f7";   // purple = phone only
        if (match && match.available) color = "#0ea5e9"; // blue = reachable/available

        const link = (match && match.bookingUrl) ? match.bookingUrl
                   : (c.phoneOnly && c.phone ? `tel:${c.phone.replace(/\s+/g,"")}` : (c.url || null));

        let popup = `<strong>${c.name}</strong>`;
        if (c.phoneOnly && c.phone){
          popup += `<br><a href="tel:${c.phone.replace(/\s+/g,"")}" target="_blank">Call ${c.phone}</a>`;
        } else if (link){
          popup += `<br><a href="${link}" target="_blank">Go to booking</a>`;
        } else {
          popup += `<br>No direct link`;
        }

        L.circleMarker([c.lat, c.lng], markerStyle(color)).addTo(markersLayer).bindPopup(popup);
      });
    }

    function renderStrip(resultsByName = {}){
      const wrap = document.getElementById("courseStrip");
      wrap.innerHTML = "";
      courseList.forEach(c => {
        const key = (c.name||"").toLowerCase();
        const match = resultsByName[key];
        const statusText = c.phoneOnly ? "Phone bookings" : (match && match.available ? "Available" : "Unavailable");
        const statusColor = c.phoneOnly ? "#a855f7" : (match && match.available ? "#0ea5e9" : "#ef4444");

        const link = (match && match.bookingUrl) ? match.bookingUrl
                   : (c.phoneOnly && c.phone ? `tel:${c.phone.replace(/\s+/g,"")}` : (c.url || null));

        const div = document.createElement("div");
        div.className = "course-card";
        div.innerHTML = `
          <div class="badge" style="background:${statusColor};color:#fff;">${statusText}</div>
          <h4 style="margin:2px 0 4px;">${c.name}</h4>
          <p style="font-size:.7rem;margin:0 0 6px;">${c.city || "WA"}</p>
          ${link ? `<button class="btn-small" onclick="window.open('${link}','_blank')">Go to booking</button>` : `<button class="btn-small" disabled>No link</button>`}
        `;
        wrap.appendChild(div);
      });
    }

    async function loadCourses(){
      const res = await fetch("/api/courses");
      courseList = await res.json();
      return courseList;
    }

    async function doSearch(){
      const statusEl = document.getElementById("status");
      const date     = document.getElementById("date").value;
      const earliest = document.getElementById("timeStart").value || "06:00";
      const latest   = document.getElementById("timeEnd").value || "17:00";
      const holes    = document.getElementById("holes").value;
      const players  = document.getElementById("players").value;

      if (!date){ statusEl.textContent = "Please select a date."; return; }
      statusEl.textContent = "Checking courses…";

      try{
        const r = await fetch("/api/search", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ date, earliest, latest, holes, partySize: players })
        });
        const j = await r.json();
        const byName = {};
        (j.slots || []).forEach(s => {
          byName[(s.name||"").toLowerCase()] = { available: !!s.available, bookingUrl: s.bookingUrl || s.url || s.link };
        });
        renderMarkers(byName);
        renderStrip(byName);
        statusEl.textContent = "Live check complete.";
      } catch (e){
        console.warn(e);
        statusEl.textContent = "Could not reach backend — showing default map.";
        renderMarkers({});
        renderStrip({});
      }
    }

    (async function start(){
      initMap();
      document.getElementById("date").value = new Date().toISOString().slice(0,10);
      await loadCourses();          // <- loads 20+ from backend
      renderMarkers({});            // <- show all markers immediately
      renderStrip({});
    })();

    document.getElementById("searchBtn").addEventListener("click", doSearch);
  </script>
</body>
</html>

