<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar — WA Realtime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/assets/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #eef3f1;
    }
    header {
      background: #036b65;
      color: #fff;
      padding: 12px 4vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .btn-home {
      background: #fff;
      color: #036b65;
      border: none;
      padding: 6px 16px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
    }
    .filters {
      display: flex;
      gap: 12px;
      padding: 16px 4vw;
      align-items: center;
      flex-wrap: wrap;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.04);
    }
    .filters input,
    .filters select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #fff;
    }
    .filters button {
      background: #036b65;
      color: #fff;
      border: none;
      padding: 9px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    #map {
      height: calc(100vh - 150px);
      margin: 0 4vw 20px;
      border-radius: 18px;
      overflow: hidden;
    }
    #status {
      padding: 6px 4vw;
      font-size: .8rem;
      color: #475569;
    }
    @media(max-width:900px){
      #map { height: 55vh; margin: 0 2vw 18px; }
    }
  </style>
  <script src="/assets/leaflet.js"></script>
</head>
<body>
  <header>
    <div style="font-weight:700;">TeeRadar WA</div>
    <button class="btn-home" onclick="window.location.href='/'">Return Home</button>
  </header>

  <div class="filters">
    <input type="date" id="date" />
    <select id="holes">
      <option value="">Any holes</option>
      <option value="9">9 holes</option>
      <option value="18">18 holes</option>
    </select>
    <select id="players">
      <option value="1">1 Player</option>
      <option value="2">2 Players</option>
      <option value="3">3 Players</option>
      <option value="4" selected>4 Players</option>
    </select>
    <button id="searchBtn">Search Availability</button>
  </div>

  <div id="status">Ready.</div>
  <div id="map"></div>

  <script>
    let map, markersLayer;
    let courseList = [];

    function initMap(){
      map = L.map("map").setView([-31.95, 115.86], 9);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    async function loadCourses(){
      const res = await fetch("/assets/courses.json");
      courseList = await res.json();
      return courseList;
    }

    function markerColor(color) {
      // simple circle-style marker
      return {
        radius: 7,
        fillColor: color,
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: .9
      };
    }

    function renderMarkers(resultsByName = {}){
      markersLayer.clearLayers();
      courseList.forEach(c => {
        const key = (c.name || "").toLowerCase();
        const match = resultsByName[key];
        let color = "#ef4444"; // red = unavailable
        if (c.phoneOnly) {
          color = "#8b5cf6"; // purple
        } else if (match && match.available) {
          color = "#0ea5e9"; // blue = available
        }
        const m = L.circleMarker([c.lat, c.lng], markerColor(color))
          .addTo(markersLayer)
          .bindPopup(`<strong>${c.name}</strong><br>${match && match.url ? `<a href="${match.url}" target="_blank">Go to booking</a>` : "No direct URL"}`);
      });
    }

    async function doSearch(){
      const statusEl = document.getElementById("status");
      const date = document.getElementById("date").value;
      const holes = document.getElementById("holes").value;
      const players = document.getElementById("players").value;
      if (!date){
        statusEl.textContent = "Please choose a date.";
        return;
      }
      statusEl.textContent = "Checking courses… this can take a few seconds";
      try {
        const res = await fetch("/api/search", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            date,
            earliest: "06:00",
            latest: "17:00",
            holes,
            partySize: players
          })
        });
        const data = await res.json();
        const byName = {};
        (data.slots || []).forEach(s => {
          byName[(s.name || "").toLowerCase()] = {
            available: true,
            url: s.url
          };
        });
        renderMarkers(byName);
        statusEl.textContent = "Live check complete.";
      } catch (err) {
        console.warn(err);
        statusEl.textContent = "Could not reach backend — showing default markers.";
        renderMarkers({});
      }
    }

    (async function start(){
      initMap();
      await loadCourses();
      renderMarkers({});
      // default date = today
      const today = new Date().toISOString().slice(0,10);
      document.getElementById("date").value = today;
    })();

    document.getElementById("searchBtn").addEventListener("click", doSearch);
  </script>
</body>
</html>

