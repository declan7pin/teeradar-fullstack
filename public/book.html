<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar ‚Äî Book a Tee Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google AdSense (auto ads) -->
  <script
    async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7954721781460856"
    crossorigin="anonymous">
  </script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root {
      --teal: #006b57;
      --teal-dark: #004e40;
      --green: #00c853;
      --red: #d50000;
      --purple: #7e57c2;
      --yellow: #f9a825;
      --bg: #f4f4f4;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: #222;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--teal);
      color: #fff;
    }

    .top-bar-title { font-weight: 600; }

    .top-bar button {
      border: none;
      background: #fff;
      color: var(--teal);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }

    .filters {
      background: #fff;
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .filter-group {
      flex: 1 1 140px;
      min-width: 0;
    }

    .filter-label {
      font-size: 12px;
      color: #555;
      margin-bottom: 2px;
    }

    .filter-control {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .search-btn {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      background: var(--teal);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
    }

    .status-line {
      font-size: 13px;
      padding: 6px 16px 0 16px;
      color: #555;
    }

    #map {
      height: 320px;
      margin: 10px 16px;
      border-radius: 12px;
      overflow: hidden;
      background: #ddd;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      padding: 0 16px 6px 16px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.25);
    }

    .dot-green { background: var(--green); }
    .dot-red { background: var(--red); }
    .dot-purple { background: var(--purple); }
    .dot-yellow { background: var(--yellow); }

    .courses-strip {
      padding: 8px 12px 16px 12px;
      overflow-x: auto;
      display: flex;
      gap: 10px;
    }

    .course-card {
      min-width: 260px;
      max-width: 280px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .course-header {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .course-sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: #f1f1f1;
      color: #444;
    }

    .chip-provider {
      background: #eef7ff;
      color: #0b63ce;
    }

    .chip-availability-green {
      background: #e6f9ef;
      color: #1b7d45;
    }

    .chip-availability-red {
      background: #ffeaea;
      color: #b03030;
    }

    .chip-availability-purple {
      background: #f3e8ff;
      color: #673ab7;
    }

    .chip-availability-yellow {
      background: #fff8e1;
      color: #996600;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .booking-link {
      color: #0059ff;
      font-weight: 600;
      cursor: pointer;
    }

    .booking-link[aria-disabled="true"] {
      color: #999;
      cursor: default;
    }

    .marker-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4);
    }

    .marker-green { background: var(--green); }
    .marker-red { background: var(--red); }
    .marker-purple { background: var(--purple); }
    .marker-yellow { background: var(--yellow); }

    @media (min-width: 800px) {
      #map { height: 380px; }
      .courses-strip { flex-wrap: wrap; overflow-x: visible; }
      .course-card { flex: 0 0 calc(33.33% - 12px); }
    }

    /* ---- State selector ---- */
    .state-selector {
      position: relative;
      margin-left: auto;
      margin-right: 8px;
    }

    .state-selector-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: var(--teal-dark);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }

    .state-selector-chevron {
      font-size: 11px;
      opacity: 0.9;
    }

    .state-dropdown {
      position: absolute;
      right: 0;
      top: 110%;
      min-width: 220px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      border: 1px solid rgba(0,0,0,0.08);
      padding: 4px 0;
      z-index: 50;
      display: none;
    }

    .state-dropdown.open {
      display: block;
    }

    .state-option {
      width: 100%;
      text-align: left;
      padding: 6px 10px;
      border: none;
      background: transparent;
      font-size: 13px;
      color: #222;
      cursor: pointer;
    }

    .state-option:hover {
      background-color: rgba(0,0,0,0.04);
    }

    .state-option.state-coming-soon {
      color: #777;
      font-style: italic;
    }

    .state-divider {
      margin: 4px 0;
      border-top: 1px solid rgba(0,0,0,0.06);
    }
  </style>
</head>

<body>
  <header class="top-bar">
    <div class="top-bar-title">TeeRadar ‚Äî Book a Tee Time</div>

    <div class="state-selector">
      <button id="stateSelectorButton" class="state-selector-button" type="button">
        <span id="stateSelectorLabel">State: WA</span>
        <span class="state-selector-chevron">‚ñæ</span>
      </button>
      <div id="stateDropdown" class="state-dropdown">
        <!-- Active states -->
        <button class="state-option" data-state="WA">Western Australia (WA)</button>
        <button class="state-option" data-state="NT">Northern Territory (NT)</button>
        <button class="state-option" data-state="QLD">Queensland (QLD)</button>

        <div class="state-divider"></div>

        <!-- Coming soon states -->
        <button class="state-option state-coming-soon" data-state="NSW">New South Wales (NSW) ‚Äì Coming soon</button>
        <button class="state-option state-coming-soon" data-state="VIC">Victoria (VIC) ‚Äì Coming soon</button>
        <button class="state-option state-coming-soon" data-state="SA">South Australia (SA) ‚Äì Coming soon</button>
        <button class="state-option state-coming-soon" data-state="TAS">Tasmania (TAS) ‚Äì Coming soon</button>
        <button class="state-option state-coming-soon" data-state="ACT">Australian Capital Territory (ACT) ‚Äì Coming soon</button>
      </div>
    </div>

    <button onclick="window.location.href='index.html'">Return Home</button>
  </header>

  <section class="filters">
    <div class="filters-row">
      <div class="filter-group">
        <div class="filter-label">Date</div>
        <input id="date" class="filter-control" type="date" />
      </div>
      <div class="filter-group">
        <div class="filter-label">Earliest</div>
        <input id="earliest" class="filter-control" type="time" value="06:00" />
      </div>
      <div class="filter-group">
        <div class="filter-label">Latest</div>
        <input id="latest" class="filter-control" type="time" value="17:00" />
      </div>
      <div class="filter-group">
        <div class="filter-label">Holes</div>
        <select id="holes" class="filter-control">
          <option value="9">9 holes</option>
          <option value="18">18 holes</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Players</div>
        <select id="players" class="filter-control">
          <option value="1">1 player</option>
          <option value="2">2 players</option>
          <option value="3" selected>3 players</option>
          <option value="4">4 players</option>
        </select>
      </div>
    </div>
    <button class="search-btn" onclick="runSearch()">Search availability</button>
  </section>

  <div class="status-line" id="status-line">
    Tap ‚ÄúSearch availability‚Äù to check live times.
  </div>

  <div id="map"></div>

  <div class="legend">
    <div class="legend-item">
      <span class="legend-dot dot-green"></span> Available
    </div>
    <div class="legend-item">
      <span class="legend-dot dot-red"></span> Not available
    </div>
    <div class="legend-item">
      <span class="legend-dot dot-purple"></span> Phone booking
    </div>
    <div class="legend-item">
      <span class="legend-dot dot-yellow"></span> Unable to confirm availability
    </div>
  </div>

  <section class="courses-strip" id="courses-strip"></section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let markers = [];
    let courses = [];
    let lastSearchCriteria = null; // { date, earliest, latest, holes, partySize, state }
    let groupedSlots = {};         // courseName => [slots]

    // full list + state handling
    let allCourses = [];
    let selectedState = "WA";
    const ACTIVE_STATES = ["WA", "NT", "QLD"];

    const statusLine = document.getElementById("status-line");
    const coursesStrip = document.getElementById("courses-strip");

    // analytics helper (used for searches + booking clicks)
    function trackEvent(type, payload) {
      try {
        fetch("/api/analytics/event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type,
            payload: payload || {},
            at: new Date().toISOString(),
          }),
        });
      } catch (err) {
        console.warn("analytics error", err);
      }
    }

    // üí° helper to turn a phone string into a tel: href
    function getTelHref(phone) {
      if (!phone) return "";
      const digits = String(phone).replace(/[^\d+]/g, "");
      if (!digits) return "";
      return "tel:" + digits;
    }

    init();

    async function init() {
      initMap();
      await loadCourses();
      // use the logged-in user's home course (if any) to set state + zoom
      applyHomeCourseDefaults();
      renderCourses();
    }

    function initMap() {
      map = L.map("map").setView([-31.95, 115.86], 5.8);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);
    }

    async function loadCourses() {
      try {
        const res = await fetch("/api/courses");
        courses = await res.json();

        allCourses = Array.isArray(courses) ? courses : [];
        window.allCourses = allCourses;

        applyStateFilter();
      } catch (err) {
        console.error("Failed to load courses", err);
        courses = [];
        allCourses = [];
      }
    }

    // ---- read stored user + apply home course defaults ----
    function getStoredUser() {
      // Preferred: object previously saved as "tr_user"
      try {
        const raw = localStorage.getItem("tr_user");
        if (raw) {
          return JSON.parse(raw);
        }
      } catch (e) {
        // ignore parse errors and fall back
      }

      // Fallback: older storage where we only saved "teeradar_home_course"
      const legacyHomeRaw = localStorage.getItem("teeradar_home_course");
      if (!legacyHomeRaw) return null;

      // Normalise course names so "Darwin Golf Club (18 holes weekday) (NT)"
      // will still match the actual course name.
      function cleanName(str) {
        if (!str) return "";
        let s = String(str).toLowerCase();

        // remove explicit state like "(nt)" or "(wa)"
        s = s.replace(/\(\s*(wa|nt|qld|nsw|vic|sa|tas|act)\s*\)/gi, "");

        // drop anything from first "(" onwards
        const idx = s.indexOf("(");
        if (idx >= 0) {
          s = s.slice(0, idx);
        }

        return s.trim();
      }

      const targetClean = cleanName(legacyHomeRaw);
      let match = null;

      if (Array.isArray(allCourses) && targetClean) {
        match = allCourses.find((c) => {
          const cname = cleanName(c.name || "");
          return cname === targetClean || cname.includes(targetClean) || targetClean.includes(cname);
        });
      }

      // Try to infer state from the string, e.g. "(NT)"
      let inferredState = null;
      const stateMatch = legacyHomeRaw.match(/\b(WA|NT|QLD|NSW|VIC|SA|TAS|ACT)\b/i);
      if (stateMatch) {
        inferredState = stateMatch[1].toUpperCase();
      }

      if (!match) {
        return {
          homeCourse: legacyHomeRaw,
          homeCourseId: null,
          homeCourseState: inferredState
        };
      }

      return {
        homeCourse: legacyHomeRaw,
        homeCourseId: match.id || null,
        homeCourseState: match.state ? String(match.state).toUpperCase() : inferredState
      };
    }

    function applyHomeCourseDefaults() {
      if (!map || !Array.isArray(allCourses) || allCourses.length === 0) {
        return;
      }

      const user = getStoredUser();

      if (!user) {
        applyStateFilter();
        zoomToStateCourses();
        const pretty = getPrettyStateName(selectedState);
        if (statusLine && ACTIVE_STATES.includes(selectedState)) {
          statusLine.textContent =
            `Showing courses in ${pretty}. Tap ‚ÄúSearch availability‚Äù to check live times.`;
          statusLine.style.color = "#555";
        }
        return;
      }

      // Use the user's homeCourseState if it's one of the active states
      if (user.homeCourseState && ACTIVE_STATES.includes(user.homeCourseState)) {
        selectedState = user.homeCourseState;
      }

      applyStateFilter();

      // Prefer homeCourseId, fall back to matching by name
      let homeCourse = null;
      if (user.homeCourseId) {
        homeCourse = allCourses.find((c) => c.id === user.homeCourseId);
      }
      if (!homeCourse && user.homeCourse) {
        const targetName = user.homeCourse.toLowerCase().trim();
        homeCourse = allCourses.find(
          (c) => (c.name || "").toLowerCase().trim() === targetName
        );
      }

      if (
        homeCourse &&
        typeof homeCourse.lat === "number" &&
        typeof homeCourse.lng === "number"
      ) {
        map.setView([homeCourse.lat, homeCourse.lng], 12);
      } else {
        zoomToStateCourses();
      }

      const pretty = getPrettyStateName(selectedState);
      if (statusLine && ACTIVE_STATES.includes(selectedState)) {
        statusLine.textContent =
          `Showing courses in ${pretty}. Tap ‚ÄúSearch availability‚Äù to check live times.`;
        statusLine.style.color = "#555";
      }

      const labelEl = document.getElementById("stateSelectorLabel");
      if (labelEl) {
        labelEl.textContent = `State: ${selectedState}`;
      }
    }

    // ---- state helpers ----
    function applyStateFilter() {
      if (!Array.isArray(allCourses) || allCourses.length === 0) {
        courses = [];
        return;
      }
      courses = allCourses.filter((c) => {
        if (!selectedState) return true;
        const code = (c.state || "WA").toString().toUpperCase();
        return code === selectedState;
      });
    }

    function getPrettyStateName(code) {
      if (!code) return "Western Australia";
      const upper = String(code).toUpperCase();
      switch (upper) {
        case "WA": return "Western Australia";
        case "NT": return "Northern Territory";
        case "QLD": return "Queensland";
        case "NSW": return "New South Wales";
        case "VIC": return "Victoria";
        case "SA": return "South Australia";
        case "TAS": return "Tasmania";
        case "ACT": return "Australian Capital Territory";
        default: return "Australia";
      }
    }

    // üîπ Zoom map to all courses in the current state
    function zoomToStateCourses() {
      if (!map || !Array.isArray(courses) || courses.length === 0) return;

      const coords = courses
        .filter(c => typeof c.lat === "number" && typeof c.lng === "number")
        .map(c => [c.lat, c.lng]);

      if (!coords.length) return;

      const bounds = L.latLngBounds(coords);
      map.fitBounds(bounds, { padding: [40, 40] });
    }

    // ---- date helper: is the search date a weekend? ----
    function isWeekendDateStr(dateStr) {
      if (!dateStr) return false;
      const d = new Date(dateStr);
      const day = d.getDay();
      return day === 0 || day === 6;
    }

    // ---- SEARCH & RENDER ----
    async function runSearch() {
      const date = document.getElementById("date").value;
      const earliest = document.getElementById("earliest").value || "06:00";
      const latest = document.getElementById("latest").value || "17:00";
      const holes = document.getElementById("holes").value;
      const players = document.getElementById("players").value;

      if (!date) {
        alert("Please select a date.");
        return;
      }

      lastSearchCriteria = {
        date,
        earliest,
        latest,
        holes,
        partySize: Number(players) || 1,
        state: selectedState || "",
      };

      window.teeRadarLastSearchDate = date;

      statusLine.textContent = "Checking live availability...";
      statusLine.style.color = "#555";

      try {
        const res = await fetch("/api/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(lastSearchCriteria),
        });

        const data = await res.json();
        const slots = Array.isArray(data.slots) ? data.slots : [];

        groupedSlots = {};
        slots.forEach((s) => {
          const name = s.course || s.courseName || s.courseTitle || s.course_name;
          if (!name) return;
          if (!groupedSlots[name]) groupedSlots[name] = [];
          groupedSlots[name].push(s);
        });

        trackEvent("search", {
          date,
          earliest,
          latest,
          holes,
          partySize: Number(players) || 1,
          state: selectedState || "",
          slots: slots.length,
        });

        const selectedHoles = Number(holes);
        let availableCourses = 0;
        let totalSlots = 0;

        Object.entries(groupedSlots).forEach(([courseName, cSlots]) => {
          const course = courses.find((c) => c.name === courseName);
          if (!course) return;

          const provider = course.provider || "Other";
          const isPhone = provider === "Phone";

          if (
            !isPhone &&
            selectedHoles &&
            typeof course.holes === "number" &&
            Number(course.holes) !== selectedHoles
          ) {
            return;
          }

          availableCourses++;
          totalSlots += cSlots.length;
        });

        if (totalSlots === 0) {
          statusLine.textContent =
            "No matching tee times found in that window. Try adjusting the filters.";
          statusLine.style.color = "#b03030";
        } else {
          statusLine.textContent =
            `Updated. ${availableCourses} courses have availability (${totalSlots} slots). ` +
            "Tap a course to view live times on the official booking site.";
          statusLine.style.color = "#1b7d45";
        }

        renderCourses();
      } catch (err) {
        console.error("Search error", err);
        statusLine.textContent = "Error checking availability. Please try again.";
        statusLine.style.color = "#b03030";
      }
    }

    function clearMarkers() {
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
    }

    function createMarkerIcon(kind) {
      let className = "marker-dot marker-red";
      if (kind === "available") className = "marker-dot marker-green";
      if (kind === "phone") className = "marker-dot marker-purple";
      if (kind === "unknown") className = "marker-dot marker-yellow";
      return L.divIcon({ className, iconSize: [14, 14] });
    }

    function renderCourses() {
      clearMarkers();
      coursesStrip.innerHTML = "";

      const selectedHoles = Number(
        (lastSearchCriteria && lastSearchCriteria.holes) ||
        document.getElementById("holes").value ||
        0
      );

      const searchDate = lastSearchCriteria && lastSearchCriteria.date;
      const dateIsWeekend = searchDate ? isWeekendDateStr(searchDate) : null;

      courses.forEach((course) => {
        const name = course.name || "";
        const provider = course.provider || "Other";
        const isPhone = provider === "Phone";
        const isTeeItUp = provider === "TeeItUp";
        const isChronogolf = provider === "Chronogolf";
        const isClickThroughOnly = isTeeItUp || isChronogolf;

        if (searchDate) {
          const hasWeekendWord = /weekend/i.test(name);
          const hasWeekdayWord = /weekday/i.test(name);

          if (hasWeekendWord && dateIsWeekend === false) {
            return;
          }
          if (hasWeekdayWord && dateIsWeekend === true) {
            return;
          }
        }

        const isUnconfirmed =
          isClickThroughOnly ||
          name.startsWith("Wembley Golf Course") ||
          name.startsWith("Meadow Springs Golf Course") ||
          name.startsWith("Meadow Springs Golf & Country Club");

        if (
          !isPhone &&
          selectedHoles &&
          typeof course.holes === "number" &&
          Number(course.holes) !== selectedHoles
        ) {
          return;
        }

        const slots = groupedSlots[name] || [];
        const hasSlots = slots.length > 0;

        let markerKind = "unavailable";
        if (isPhone) {
          markerKind = "phone";
        } else if ((isClickThroughOnly && !hasSlots) || isUnconfirmed) {
          markerKind = "unknown";
        } else if (hasSlots) {
          markerKind = "available";
        }

        if (typeof course.lat === "number" && typeof course.lng === "number") {
          const marker = L.marker([course.lat, course.lng], {
            icon: createMarkerIcon(markerKind),
          }).addTo(map);

          let popupHtml = `<div style="font-size:13px;">
            <strong>${name}</strong><br>${provider}`;

          if (isClickThroughOnly || isUnconfirmed) {
            popupHtml += `<br><strong>Unable to confirm availability</strong>`;
          } else if (hasSlots) {
            popupHtml += `<br>${slots.length} slots`;
          } else if (isPhone) {
            popupHtml += `<br>Phone booking`;
            if (course.phone) {
              const telHref = getTelHref(course.phone);
              if (telHref) {
                popupHtml += `<br><strong><a href="${telHref}">${course.phone}</a></strong>`;
              } else {
                popupHtml += `<br><strong>${course.phone}</strong>`;
              }
            }
          }

          if (!isPhone) {
            popupHtml += `<br><span
              class="booking-link"
              role="button"
              data-course-name="${encodeURIComponent(name)}"
              style="display:inline-block;margin-top:4px;"
            >Go to booking</span>`;
          }

          popupHtml += `</div>`;

          marker.bindPopup(popupHtml);
          markers.push(marker);
        }

        const card = document.createElement("article");
        card.className = "course-card";

        const holesLabel =
          course.holes === 9 ? "9 holes" :
          course.holes === 18 ? "18 holes" :
          `${course.holes} holes`;

        let availChipClass = "chip-availability-red";
        let availLabel = "No availability";

        if (isPhone) {
          availChipClass = "chip-availability-purple";
          availLabel = "Phone booking";
        } else if (isClickThroughOnly && !hasSlots) {
          availChipClass = "chip-availability-yellow";
          availLabel = "Check course site";
        } else if (isUnconfirmed) {
          availChipClass = "chip-availability-yellow";
          availLabel = "Unable to confirm availability";
        } else if (hasSlots) {
          availChipClass = "chip-availability-green";
          availLabel = "Available";
        }

        const providerLabel =
          provider === "MiClub"
            ? "MiClub ‚Ä¢ live check"
            : provider === "Quick18"
            ? "Quick18 ‚Ä¢ live check"
            : provider === "TeeItUp"
            ? "TeeItUp"
            : provider === "Chronogolf"
            ? "Chronogolf"
            : provider === "Phone"
            ? "Phone booking"
            : provider;

        const phoneText = isPhone && course.phone ? course.phone : "";
        const phoneHref = isPhone && course.phone ? getTelHref(course.phone) : "";

        card.innerHTML = `
          <div>
            <div class="course-header">${name}</div>
            <div class="course-sub">Western Australia</div>
            <div class="chip-row">
              <span class="chip chip-provider">${providerLabel}</span>
              <span class="chip ${availChipClass}">${availLabel}</span>
              <span class="chip">${holesLabel}</span>
            </div>
          </div>
          <div class="card-footer">
            <span>${
              isClickThroughOnly || isUnconfirmed
                ? "Check course site"
                : hasSlots
                ? slots.length + " slots"
                : isPhone
                ? (phoneHref ? `<a href="${phoneHref}">${phoneText}</a>` : phoneText)
                : ""
            }</span>
            ${
              isPhone
                ? ""
                : `<span class="booking-link"
                         role="button"
                         data-course-name="${encodeURIComponent(name)}"
                         aria-disabled="${hasSlots || isClickThroughOnly || isUnconfirmed ? "false" : "true"}">
                      Go to booking
                   </span>`
            }
          </div>
        `;

        const subStateEl = card.querySelector(".course-sub");
        if (subStateEl) {
          subStateEl.textContent = getPrettyStateName(course.state);
        }

        coursesStrip.appendChild(card);
      });
    }

    // Handle clicks on "Go to booking" (cards + map popups)
    document.addEventListener("click", (evt) => {
      const el = evt.target.closest(".booking-link");
      if (!el) return;

      const disabled = el.getAttribute("aria-disabled") === "true";
      if (disabled) return;

      const courseNameEncoded = el.dataset.courseName;
      if (!courseNameEncoded) return;

      const courseName = decodeURIComponent(courseNameEncoded);
      const course = courses.find((c) => c.name === courseName);
      if (!course) return;

      const provider = course.provider || "Other";
      const slots = groupedSlots[courseName] || [];
      const exampleSlot = slots[0] || {};
      const searchDate =
        (lastSearchCriteria && lastSearchCriteria.date) ||
        window.teeRadarLastSearchDate;

      let baseUrl = "";

      if (provider === "TeeItUp" && course.url) {
        try {
          const u = new URL(course.url);
          if (searchDate) {
            u.searchParams.set("date", searchDate);
          }
          baseUrl = u.toString();
        } catch (e) {
          baseUrl = course.url;
        }
      } else {
        baseUrl =
          exampleSlot.bookingUrl ||
          exampleSlot.url ||
          course.url ||
          "";
      }

      if (!baseUrl) return;

      let finalUrl = baseUrl;

      try {
        const u = new URL(baseUrl);

        if (provider === "MiClub") {
          if (searchDate) u.searchParams.set("selectedDate", searchDate);
          u.searchParams.delete("recaptchaResponse");
          u.searchParams.delete("mobile");
          finalUrl = u.toString();
        } else if (provider === "Quick18") {
          if (searchDate) {
            const yyyymmdd = searchDate.replace(/-/g, "");
            u.searchParams.set("teedate", yyyymmdd);
          }
          finalUrl = u.toString();
        }
      } catch (err) {
        console.error("Error building booking URL:", err);
      }

      trackEvent("course_booking_click", {
        courseName,
        provider,
        url: finalUrl,
        state: course.state || null,
      });

      window.open(finalUrl, "_blank");
    });

    (function setDefaultDate() {
      const input = document.getElementById("date");
      if (!input) return;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      input.value = `${yyyy}-${mm}-${dd}`;
    })();

    // State selector behaviour
    (function setupStateSelector() {
      const btn = document.getElementById("stateSelectorButton");
      const dropdown = document.getElementById("stateDropdown");
      const label = document.getElementById("stateSelectorLabel");

      if (!btn || !dropdown) return;

      function setState(stateCode, stateLabel) {
        selectedState = stateCode;
        if (label) {
          label.textContent = `State: ${stateCode}`;
        }

        const prettyName = getPrettyStateName(stateCode);

        if (ACTIVE_STATES.includes(stateCode)) {
          applyStateFilter();

          if (lastSearchCriteria) {
            runSearch();
          } else {
            renderCourses();
            zoomToStateCourses();
            if (statusLine) {
              statusLine.textContent =
                `Showing courses in ${prettyName}. Tap ‚ÄúSearch availability‚Äù to check live times.`;
              statusLine.style.color = "#555";
            }
          }
        } else {
          courses = [];
          renderCourses();
          if (statusLine) {
            statusLine.textContent =
              `${prettyName} is coming soon to TeeRadar. For now, WA, NT & QLD are live.`;
            statusLine.style.color = "#9a3412";
          }
        }
      }

      btn.addEventListener("click", function (e) {
        e.stopPropagation();
        dropdown.classList.toggle("open");
      });

      dropdown.addEventListener("click", function (e) {
        const option = e.target.closest(".state-option");
        if (!option) return;
        const stateCode = option.getAttribute("data-state");
        const stateLabel = option.textContent.trim();
        dropdown.classList.remove("open");
        if (!stateCode) return;
        setState(stateCode, stateLabel);
      });

      document.addEventListener("click", function (e) {
        if (!dropdown.classList.contains("open")) return;
        if (!e.target.closest(".state-selector")) {
          dropdown.classList.remove("open");
        }
      });

      const initialState = selectedState || "WA";
      if (label) {
        label.textContent = `State: ${initialState}`;
      }
    })();
  </script>
</body>
</html>