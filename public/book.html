<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar — Book a Tee Time</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/assets/leaflet.css" />
  <style>
    :root {
      --teal:#036b65;
      --bg:#eef3f1;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:#0f172a;
    }
    header{
      background:var(--teal);
      color:#fff;
      padding:10px 4vw;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    header h1{
      margin:0;
      font-size:1rem;
      letter-spacing:.03em;
    }
    .home-btn{
      background:#fff;
      color:var(--teal);
      border:none;
      padding:6px 16px;
      border-radius:999px;
      font-weight:600;
      font-size:.8rem;
      cursor:pointer;
    }
    .filters{
      background:#fff;
      padding:14px 4vw;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .filters label{
      font-size:.72rem;
      font-weight:600;
      color:#475569;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .filters input,
    .filters select{
      border:1px solid #d1d5db;
      border-radius:8px;
      padding:6px 10px;
      font-size:.8rem;
      min-width:90px;
    }
    .filters button{
      background:var(--teal);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:8px 16px;
      font-weight:600;
      font-size:.8rem;
      cursor:pointer;
      white-space:nowrap;
    }
    #status{
      font-size:.75rem;
      padding:4px 4vw 8px;
      color:#475569;
    }
    #map{
      height:420px;
      margin:0 4vw;
      border-radius:16px;
      overflow:hidden;
      background:#cbd5f5;
      box-shadow:0 16px 35px rgba(15,23,42,.12);
    }
    .course-strip{
      margin:16px 4vw 24px;
      display:flex;
      gap:14px;
      overflow-x:auto;
      padding-bottom:10px;
    }
    .course-card{
      min-width:240px;
      background:var(--card);
      border-radius:14px;
      border:1px solid rgba(15,23,42,.06);
      box-shadow:0 10px 24px rgba(15,23,42,.06);
      padding:12px 12px 14px;
      flex:0 0 auto;
    }
    .course-card h4{
      margin:2px 0 4px;
      font-size:.9rem;
    }
    .course-card p{
      margin:0 0 6px;
      font-size:.7rem;
      color:#64748b;
    }

    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      font-size:.6rem;
      margin-bottom:6px;
      font-weight:600;
    }
    .badge-status-grey{background:#e5e7eb;color:#374151;}
    .badge-status-blue{background:#0ea5e9;color:#e0f2fe;}
    .badge-status-red{background:#fee2e2;color:#b91c1c;}
    .badge-status-purple{background:#f5f3ff;color:#7e22ce;}

    .badge-provider{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:.58rem;
      margin-left:6px;
      font-weight:600;
    }
    .provider-miclub{background:#dbeafe;color:#1d4ed8;}
    .provider-quick18{background:#dcfce7;color:#166534;}
    .provider-phone{background:#fef3c7;color:#92400e;}
    .provider-info{background:#e5e7eb;color:#111827;}
    .provider-generic{background:#e5e7eb;color:#111827;}

    .btn-small{
      background:#eef3f1;
      border:none;
      border-radius:10px;
      padding:6px 10px;
      font-size:.7rem;
      cursor:pointer;
      font-weight:600;
    }
    .btn-small[disabled]{
      opacity:.6;
      cursor:default;
    }

    @media (max-width:900px){
      header{padding:10px 3vw;}
      .filters{padding:12px 3vw;}
      #map{margin:0 3vw;height:55vh;}
      .course-strip{margin:16px 3vw 24px;}
    }
    @media (max-width:640px){
      .filters{
        flex-direction:column;
        align-items:stretch;
      }
      .filters label{
        width:100%;
      }
      .filters input,
      .filters select{
        width:100%;
      }
      .filters button{
        width:100%;
        justify-content:center;
        display:flex;
      }
    }
  </style>
  <script src="/assets/leaflet.js"></script>
</head>
<body>
  <header>
    <h1>TeeRadar — Book a Tee Time</h1>
    <button class="home-btn" onclick="window.location.href='/'">Return Home</button>
  </header>

  <div class="filters">
    <label>
      Date
      <input type="date" id="date" />
    </label>
    <label>
      Earliest
      <input type="time" id="timeStart" value="06:00" />
    </label>
    <label>
      Latest
      <input type="time" id="timeEnd" value="17:00" />
    </label>
    <label>
      Holes
      <select id="holes">
        <option value="">Any</option>
        <option value="9">9 holes</option>
        <option value="18">18 holes</option>
      </select>
    </label>
    <label>
      Players
      <select id="players">
        <option value="1">1 player</option>
        <option value="2">2 players</option>
        <option value="3">3 players</option>
        <option value="4" selected>4 players</option>
      </select>
    </label>
    <button id="searchBtn">Search availability</button>
  </div>

  <div id="status">Select a date and hit “Search availability” to check live course sheets.</div>

  <div id="map"></div>

  <div class="course-strip" id="courseStrip"></div>

  <script>
    let map, markersLayer, courseList = [];

    /* -----------------------
       Provider helpers
    ------------------------*/
    function providerLabel(raw) {
      const p = (raw || "").toLowerCase();
      if (p.includes("miclub"))  return "MiClub • live check";
      if (p.includes("quick18")) return "Quick18 • live check";
      if (p.includes("phone"))   return "Phone bookings only";
      if (p.includes("info"))    return "Info only";
      return raw || "Course";
    }

    function providerClass(raw) {
      const p = (raw || "").toLowerCase();
      if (p.includes("miclub"))  return "provider-miclub";
      if (p.includes("quick18")) return "provider-quick18";
      if (p.includes("phone"))   return "provider-phone";
      if (p.includes("info"))    return "provider-info";
      return "provider-generic";
    }

    /* -----------------------
       Map init
    ------------------------*/
    function initMap() {
      map = L.map("map").setView([-31.95, 115.86], 9);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function markerStyle(color) {
      return {
        radius: 7,
        fillColor: color,
        color: "#ffffff",
        weight: 1,
        fillOpacity: 0.9
      };
    }

    function getStatusForCourse(course, agg, partySize) {
      // agg = { bestSpots, hasSlots }
      if (course.phoneOnly) {
        return {
          text: "Phone to book",
          badge: "badge-status-purple",
          color: "#a855f7"
        };
      }

      if (agg && agg.hasSlots) {
        if (agg.bestSpots === 0) {
          return {
            text: "No spots in window",
            badge: "badge-status-red",
            color: "#ef4444"
          };
        }
        const label = `${agg.bestSpots} / 4 spots in window`;
        return {
          text: label,
          badge: "badge-status-blue",
          color: "#0ea5e9"
        };
      }

      // We have a URL but no parsed slots
      if (course.url) {
        return {
          text: "Tap to check times",
          badge: "badge-status-grey",
          color: "#6b7280"
        };
      }

      // Last resort
      return {
        text: "Unknown (tap to check)",
        badge: "badge-status-grey",
        color: "#6b7280"
      };
    }

    function renderMarkers(availabilityByCourse, partySize) {
      markersLayer.clearLayers();

      courseList.forEach(c => {
        const key = (c.name || "").toLowerCase();
        const agg = availabilityByCourse[key];
        const status = getStatusForCourse(c, agg, partySize);

        const link = c.phoneOnly
          ? (c.phone ? `tel:${c.phone.replace(/\\s+/g, "")}` : null)
          : (c.url || null);

        let popup = `<strong>${c.name}</strong><br/>
          <span style="font-size:.75rem;color:#6b7280;">${status.text}</span>`;

        if (c.phoneOnly && c.phone) {
          popup += `<br/><a href="tel:${c.phone.replace(/\\s+/g,"")}" target="_blank">Call ${c.phone}</a>`;
        } else if (link) {
          popup += `<br/><a href="${link}" target="_blank" rel="noopener noreferrer">Go to booking</a>`;
        } else {
          popup += `<br/>No direct link`;
        }

        L.circleMarker([c.lat, c.lng], markerStyle(status.color))
          .addTo(markersLayer)
          .bindPopup(popup);
      });
    }

    function renderStrip(availabilityByCourse, partySize) {
      const wrap = document.getElementById("courseStrip");
      wrap.innerHTML = "";

      courseList.forEach(c => {
        const key = (c.name || "").toLowerCase();
        const agg = availabilityByCourse[key];
        const status = getStatusForCourse(c, agg, partySize);

        const link = c.phoneOnly
          ? (c.phone ? `tel:${c.phone.replace(/\\s+/g, "")}` : null)
          : (c.url || null);

        const provClass = providerClass(c.provider);
        const provLabel = providerLabel(c.provider);

        const div = document.createElement("div");
        div.className = "course-card";
        div.innerHTML = `
          <div>
            <span class="badge ${status.badge}">${status.text}</span>
            <span class="badge-provider ${provClass}">${provLabel}</span>
          </div>
          <h4>${c.name}</h4>
          <p>${c.city || "Western Australia"}</p>
          ${
            link
              ? `<button class="btn-small" onclick="window.open('${link}','_blank')">Go to booking</button>`
              : `<button class="btn-small" disabled>No link</button>`
          }
        `;
        wrap.appendChild(div);
      });
    }

    async function loadCourses() {
      const res = await fetch("/api/courses");
      courseList = await res.json();
      return courseList;
    }

    async function doSearch() {
      const statusEl = document.getElementById("status");
      const date = document.getElementById("date").value;
      const earliest = document.getElementById("timeStart").value || "06:00";
      const latest = document.getElementById("timeEnd").value || "17:00";
      const holes = document.getElementById("holes").value;
      const players = parseInt(document.getElementById("players").value || "1", 10);

      if (!date) {
        statusEl.textContent = "Please select a date before searching.";
        return;
      }

      statusEl.textContent = "Checking each course for this window…";

      let slots = [];
      try {
        const r = await fetch("/api/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            date,
            earliest,
            latest,
            holes,
            partySize: players
          })
        });
        const j = await r.json();
        slots = j.slots || [];
      } catch (e) {
        console.warn("search error", e);
        statusEl.textContent = "Could not reach backend. Showing map only.";
        renderMarkers({}, players);
        renderStrip({}, players);
        return;
      }

      // Aggregate per course name: best available spots in the window
      const availabilityByCourse = {};
      slots.forEach(s => {
        const key = (s.name || "").toLowerCase();
        const spots = typeof s.spots === "number" ? s.spots : 0;
        if (!availabilityByCourse[key]) {
          availabilityByCourse[key] = {
            bestSpots: spots,
            hasSlots: spots > 0
          };
        } else {
          if (spots > availabilityByCourse[key].bestSpots) {
            availabilityByCourse[key].bestSpots = spots;
          }
          if (spots > 0) {
            availabilityByCourse[key].hasSlots = true;
          }
        }
      });

      renderMarkers(availabilityByCourse, players);
      renderStrip(availabilityByCourse, players);

      if (slots.length === 0) {
        statusEl.textContent = "No matching tee times found in that window. Try adjusting the filters.";
      } else {
        statusEl.textContent = "Updated. Tap a course to view live times on the official booking site.";
      }
    }

    (async function start() {
      initMap();
      // default date = today
      document.getElementById("date").value = new Date().toISOString().slice(0, 10);
      await loadCourses();            // 20+ WA courses
      renderMarkers({}, 4);           // initial neutral view
      renderStrip({}, 4);
    })();

    document.getElementById("searchBtn").addEventListener("click", doSearch);
  </script>
</body>
</html>

