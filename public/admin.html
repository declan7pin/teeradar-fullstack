<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar WA — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --teal: #006b57;
      --teal-soft: #e7f3f0;
      --bg: #f4f6fb;
      --card: #ffffff;
      --danger: #e53935;
      --muted: #687286;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #f0f6ff, #f4f4f4);
      color: #141820;
    }

    a { color: inherit; text-decoration: none; }

    header {
      background: #ffffff;
      border-bottom: 1px solid #e3e7f0;
    }

    .nav {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 18px;
    }

    .nav-logo-pill {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00c853, #00a86b);
      box-shadow: 0 0 0 4px #e4f8ee;
    }

    .nav-links {
      margin-left: auto;
      display: flex;
      gap: 14px;
      font-size: 14px;
    }

    .nav-link {
      color: #555f73;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .nav-link.active {
      background: #e3f5f0;
      color: #006b57;
      font-weight: 600;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 18px 16px 32px 16px;
    }

    h1 {
      margin: 0 0 4px 0;
      font-size: 26px;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      font-size: 13px;
      color: #6b7486;
      max-width: 520px;
      line-height: 1.4;
    }

    .pill-row {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--teal-soft);
      font-size: 11px;
      color: #0d5f4b;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #00c853;
    }

    .error-banner {
      margin-top: 14px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #ffecec;
      color: #b3261e;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 6px;
    }

    .error-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--danger);
    }

    .cards-grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
    }

    @media (min-width: 700px) {
      .cards-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 14px 14px 16px 14px;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.04);
      position: relative;
      overflow: hidden;
    }

    .card-corner {
      position: absolute;
      top: 0;
      right: 0;
      width: 38px;
      height: 38px;
      border-bottom-left-radius: 999px;
      background: radial-gradient(circle at top right, #e2f6f0, transparent 55%);
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #7b8696;
      margin-bottom: 6px;
    }

    .card-value {
      font-size: 30px;
      font-weight: 700;
      letter-spacing: -0.04em;
      margin-bottom: 2px;
    }

    .card-caption {
      font-size: 11px;
      color: #919bb0;
    }

    /* Two-column lower section */
    .lower-grid {
      margin-top: 20px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
    }

    @media (min-width: 800px) {
      .lower-grid {
        grid-template-columns: 1.1fr 1.3fr;
      }
    }

    .users-list {
      font-size: 13px;
      color: #374151;
      display: grid;
      gap: 8px;
      margin-top: 6px;
    }

    .users-row-label {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .users-row-value {
      font-size: 18px;
      font-weight: 600;
    }

    .courses-list {
      margin-top: 10px;
      font-size: 13px;
      color: #374151;
      display: grid;
      gap: 6px;
    }

    .course-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 4px 0;
      border-bottom: 1px dashed #e1e5f0;
    }

    .course-item:last-child {
      border-bottom: none;
    }

    .course-name {
      max-width: 70%;
    }

    .course-clicks {
      font-variant-numeric: tabular-nums;
      color: #1b7d45;
      font-weight: 600;
    }

    .muted {
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="nav-logo">
        <span class="nav-logo-pill"></span>
        <span>TeeRadar<br /><span style="font-weight:500;font-size:13px;">WA</span></span>
      </div>
      <div class="nav-links">
        <a href="admin.html" class="nav-link active">Admin</a>
        <a href="index.html" class="nav-link">Home</a>
        <a href="book.html" class="nav-link">Bookings</a>
        <a href="faq.html" class="nav-link">FAQ</a>
      </div>
    </nav>
  </header>

  <main>
    <h1>Analytics dashboard</h1>
    <p class="page-subtitle">
      Live tee-time engagement across Western Australia — updated whenever users
      view the home page, search for times, or click out to book.
    </p>

    <div class="pill-row">
      <span class="pill-dot"></span>
      <span>LIVE · SQLITE-BACKED</span>
    </div>

    <div id="error-banner" class="error-banner">
      <span class="error-dot"></span>
      <span id="error-text">Error loading analytics — see console for details.</span>
    </div>

    <!-- main metric cards -->
    <section class="cards-grid">
      <article class="card">
        <div class="card-corner"></div>
        <div class="card-title">HOME PAGE VIEWS</div>
        <div id="metric-homeViews" class="card-value">0</div>
        <div class="card-caption">Total lifetime home page loads.</div>
      </article>

      <article class="card">
        <div class="card-corner"></div>
        <div class="card-title">COURSE BOOKING CLICKS</div>
        <div id="metric-bookingClicks" class="card-value">0</div>
        <div class="card-caption">Times users tapped “Go to booking”.</div>
      </article>

      <article class="card">
        <div class="card-corner"></div>
        <div class="card-title">SEARCHES</div>
        <div id="metric-searches" class="card-value">0</div>
        <div class="card-caption">Total tee time searches performed.</div>
      </article>

      <article class="card">
        <div class="card-corner"></div>
        <div class="card-title">NEW USERS (LAST 7 DAYS)</div>
        <div id="metric-newUsers7d" class="card-value">0</div>
        <div class="card-caption">
          First-time visitors in the last week (approximate, based on IP / browser).
        </div>
      </article>
    </section>

    <!-- lower section: unique users + most clicked courses -->
    <section class="lower-grid">
      <article class="card">
        <div class="card-corner"></div>
        <div class="card-title">UNIQUE USERS</div>
        <div class="users-list">
          <div>
            <div class="users-row-label">ALL TIME</div>
            <div id="users-allTime" class="users-row-value">0</div>
          </div>
          <div>
            <div class="users-row-label">TODAY</div>
            <div id="users-today" class="users-row-value">0</div>
          </div>
          <div>
            <div class="users-row-label">LAST 7 DAYS</div>
            <div id="users-week" class="users-row-value">0</div>
          </div>
        </div>
        <p class="card-caption" style="margin-top:10px;">
          Users are estimated using IP address unless a browser ID is supplied.
        </p>
      </article>

      <article class="card">
        <div class="card-corner"></div>
        <div class="card-title">MOST CLICKED COURSES</div>
        <div id="courses-list" class="courses-list">
          <div class="muted">No booking clicks recorded yet.</div>
        </div>
        <p class="card-caption" style="margin-top:10px;">
          Ranked by total “Go to booking” clicks across all time.
        </p>
      </article>
    </section>
  </main>

  <script>
    async function loadAnalytics() {
      const errorBanner = document.getElementById("error-banner");
      const errorText = document.getElementById("error-text");

      try {
        // Summary metrics
        const summaryRes = await fetch("/api/analytics/summary");
        if (!summaryRes.ok) {
          throw new Error("summary HTTP " + summaryRes.status);
        }
        const summary = await summaryRes.json();

        const {
          homeViews = 0,
          bookingClicks = 0,
          searches = 0,
          newUsers7d = 0,
          usersAllTime = 0,
          usersToday = 0,
          usersWeek = 0
        } = summary || {};

        document.getElementById("metric-homeViews").textContent = homeViews;
        document.getElementById("metric-bookingClicks").textContent = bookingClicks;
        document.getElementById("metric-searches").textContent = searches;
        document.getElementById("metric-newUsers7d").textContent = newUsers7d;

        document.getElementById("users-allTime").textContent = usersAllTime;
        document.getElementById("users-today").textContent = usersToday;
        document.getElementById("users-week").textContent = usersWeek;

        // Top courses
        const topRes = await fetch("/api/analytics/top-courses");
        if (!topRes.ok) {
          throw new Error("top-courses HTTP " + topRes.status);
        }
        const topData = await topRes.json();
        const courses = (topData && topData.top) || [];

        const listEl = document.getElementById("courses-list");
        listEl.innerHTML = "";

        if (!courses.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No booking clicks recorded yet.";
          listEl.appendChild(empty);
        } else {
          courses.forEach((c, idx) => {
            const row = document.createElement("div");
            row.className = "course-item";
            row.innerHTML = `
              <span class="course-name">${idx + 1}. ${c.courseName}</span>
              <span class="course-clicks">${c.clicks}</span>
            `;
            listEl.appendChild(row);
          });
        }

        // hide error banner if everything worked
        errorBanner.style.display = "none";
      } catch (err) {
        console.error("Error loading analytics:", err);
        errorText.textContent =
          "Error loading analytics — check the backend logs for details.";
        errorBanner.style.display = "flex";
      }
    }

    document.addEventListener("DOMContentLoaded", loadAnalytics);
  </script>
</body>
</html>