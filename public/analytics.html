<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TeeRadar WA — Analytics dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --teal: #00796b;
      --teal-dark: #005e55;
      --bg: #f4f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --accent: #0ea5e9;
      --pill: #ecfeff;
      --danger: #b91c1c;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e0f2f1,#f9fafb);
      color:var(--text);
    }
    a{text-decoration:none;color:inherit;}
    button{font-family:inherit;}

    /* HEADER (admin style) */
    header{
      background:var(--teal);
      color:#fff;
      padding:10px 4vw;
      position:sticky;
      top:0;
      z-index:20;
      box-shadow:0 2px 6px rgba(0,0,0,0.12);
    }
    .nav-wrap{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:26px;
      height:26px;
      border-radius:999px;
      background:#ecfdf5;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#065f46;
      font-size:15px;
      font-weight:800;
      box-shadow:0 0 0 3px rgba(16,185,129,0.25);
    }
    .brand-text{
      font-weight:700;
      letter-spacing:.04em;
      font-size:15px;
    }
    nav{
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-size:13px;
    }
    nav a{
      color:#e0f2f1;
      opacity:.9;
      padding:4px 6px;
      border-radius:999px;
    }
    nav a:hover{
      background:rgba(255,255,255,0.16);
      opacity:1;
    }
    .nav-pill{
      background:rgba(15,118,110,0.18);
      border:1px solid rgba(45,212,191,0.6);
      padding:4px 10px;
      font-weight:600;
    }

    main{
      max-width:1100px;
      margin:26px auto 40px;
      padding:0 4vw 50px;
    }

    .page-kicker{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#ecfeff;
      border:1px solid #bae6fd;
      font-size:11px;
      color:#0369a1;
      font-weight:600;
      margin-bottom:8px;
    }
    .page-kicker-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,0.35);
    }

    .page-title{
      font-size:clamp(24px,3.5vw,30px);
      font-weight:800;
      letter-spacing:-0.02em;
      margin:0 0 4px;
    }
    .page-sub{
      font-size:14px;
      color:var(--muted);
      max-width:520px;
      margin:0 0 14px;
    }

    .error-banner{
      display:none;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:var(--danger);
      background:#fee2e2;
      border:1px solid #fecaca;
      border-radius:12px;
      padding:8px 10px;
      margin-bottom:14px;
    }

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
      margin-top:10px;
      margin-bottom:20px;
    }
    .metric-card{
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      padding:12px 14px 14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.08);
    }
    .metric-label{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:4px;
    }
    .metric-value{
      font-size:26px;
      font-weight:700;
      margin-bottom:2px;
    }
    .metric-sub{
      font-size:12px;
      color:var(--muted);
    }

    .section-title{
      font-size:14px;
      font-weight:700;
      margin:18px 0 6px;
    }

    .users-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      font-size:13px;
    }
    .pill-stat{
      padding:6px 10px;
      border-radius:999px;
      background:#ffffff;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill-stat span.label{
      color:var(--muted);
      font-size:12px;
    }
    .pill-stat span.val{
      font-weight:600;
    }

    .courses-list{
      margin-top:4px;
      padding-left:0;
      list-style:none;
      font-size:13px;
    }
    .courses-list li{
      padding:4px 0;
      border-bottom:1px dashed #e5e7eb;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .courses-list span.name{
      color:#0f172a;
    }
    .courses-list span.count{
      color:var(--muted);
      font-size:12px;
    }

    .updated-at{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }

    .admin-warning{
      margin-top:18px;
      font-size:13px;
      color:var(--muted);
    }

    @media (max-width:600px){
      .metric-value{font-size:22px;}
    }
  </style>
</head>
<body>
<header>
  <div class="nav-wrap">
    <div class="brand">
      <div class="brand-logo">T</div>
      <div class="brand-text">TeeRadar WA</div>
    </div>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/book.html">Bookings</a>
      <a href="/faq.html">FAQ</a>
      <a href="/about.html">About</a>
      <a href="/analytics.html" class="nav-pill">Analytics</a>
    </nav>
  </div>
</header>

<main>
  <div class="page-kicker">
    <span class="page-kicker-dot"></span>
    <span>Realtime, in-memory</span>
  </div>
  <h1 class="page-title">Analytics dashboard</h1>
  <p class="page-sub">
    Live tee-time engagement across Western Australia — updated every time a user
    searches or clicks.
  </p>

  <div id="errorBanner" class="error-banner">
    <span>●</span>
    <span>Error loading analytics — see console for details.</span>
  </div>

  <div class="metrics-grid">
    <section class="metric-card">
      <div class="metric-label">Home page views</div>
      <div id="mHomeViews" class="metric-value">0</div>
      <div id="mHomeViewsSub" class="metric-sub">—</div>
    </section>

    <section class="metric-card">
      <div class="metric-label">Course booking clicks</div>
      <div id="mBookingClicks" class="metric-value">0</div>
      <div id="mBookingClicksSub" class="metric-sub">—</div>
    </section>

    <section class="metric-card">
      <div class="metric-label">Searches</div>
      <div id="mSearches" class="metric-value">0</div>
      <div id="mSearchesSub" class="metric-sub">—</div>
    </section>

    <section class="metric-card">
      <div class="metric-label">New users</div>
      <div id="mNewUsers" class="metric-value">0</div>
      <div id="mNewUsersSub" class="metric-sub">—</div>
    </section>
  </div>

  <section>
    <h2 class="section-title">User overview</h2>
    <div class="users-row">
      <div class="pill-stat">
        <span class="label">All time</span>
        <span id="uAllTime" class="val">0</span>
      </div>
      <div class="pill-stat">
        <span class="label">Today</span>
        <span id="uToday" class="val">0</span>
      </div>
      <div class="pill-stat">
        <span class="label">This week</span>
        <span id="uWeek" class="val">0</span>
      </div>
    </div>
    <p class="updated-at" id="updatedAt">Last updated just now.</p>
  </section>

  <section>
    <h2 class="section-title">Most-clicked courses</h2>
    <ul id="topCoursesList" class="courses-list">
      <li><span class="name">No course clicks yet.</span></li>
    </ul>
  </section>

  <p class="admin-warning">
    Analytics are stored in memory on the server. Deploy restarts will reset these counts.
  </p>
</main>

<script>
  const ADMIN_EMAIL = "declan7pin@gmail.com";

  function isAdmin() {
    return (localStorage.getItem("teeradar_user_email") || "").toLowerCase() === ADMIN_EMAIL;
  }

  // Optional: basic guard so random users don't sit on this page
  function guardAdmin() {
    if (!isAdmin()) {
      console.warn("Not logged in as admin – analytics are still visible, but nav has no admin gate.");
    }
  }

  async function loadAnalytics() {
    const errorBanner = document.getElementById("errorBanner");
    errorBanner.style.display = "none";

    try {
      const res = await fetch("/api/analytics/summary", { headers: { "Accept": "application/json" } });
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      const data = await res.json();
      console.log("[analytics] page summary", data);
      applyAnalytics(data);
    } catch (err) {
      console.error("Error loading analytics summary", err);
      errorBanner.style.display = "flex";
    }
  }

  function applyAnalytics(summary) {
    // Defensive field mapping to match your backend shape
    const homeViews =
      summary.homePageViews ??
      summary.homeViews ??
      0;

    const bookingClicks =
      summary.courseBookingClicks ??
      summary.bookingClicks ??
      0;

    const searches =
      summary.searches ??
      0;

    const newUsers =
      summary.newUsers ??
      summary.newUsers7d ??
      0;

    const usersAllTime = summary.usersAllTime ?? 0;
    const usersToday   = summary.usersToday   ?? 0;
    const usersWeek    = summary.usersWeek    ?? 0;

    document.getElementById("mHomeViews").textContent = homeViews;
    document.getElementById("mBookingClicks").textContent = bookingClicks;
    document.getElementById("mSearches").textContent = searches;
    document.getElementById("mNewUsers").textContent = newUsers;

    document.getElementById("mHomeViewsSub").textContent =
      "All-time total homepage sessions.";
    document.getElementById("mBookingClicksSub").textContent =
      "Total unique clicks through to course booking pages.";
    document.getElementById("mSearchesSub").textContent =
      "Total search requests sent to /api/search.";
    document.getElementById("mNewUsersSub").textContent =
      "New browser devices seen in the last 7 days.";

    document.getElementById("uAllTime").textContent = usersAllTime;
    document.getElementById("uToday").textContent   = usersToday;
    document.getElementById("uWeek").textContent    = usersWeek;

    const updatedAtText = "Last updated " + new Date().toLocaleString();
    document.getElementById("updatedAt").textContent = updatedAtText;

    // Top courses
    const listEl = document.getElementById("topCoursesList");
    listEl.innerHTML = "";

    const topCourses = Array.isArray(summary.topCourses) ? summary.topCourses : [];

    if (!topCourses.length) {
      const li = document.createElement("li");
      li.innerHTML = '<span class="name">No course clicks yet.</span>';
      listEl.appendChild(li);
      return;
    }

    topCourses.forEach((c) => {
      const name =
        c.name ||
        c.courseName ||
        c.course ||
        "Unknown course";
      const clicks = c.clicks ?? c.total ?? c.count ?? 0;

      const li = document.createElement("li");
      li.innerHTML =
        '<span class="name">' +
        name +
        '</span><span class="count">' +
        clicks +
        ' clicks</span>';
      listEl.appendChild(li);
    });
  }

  guardAdmin();
  loadAnalytics();
  // if you want auto-refresh every 30s, uncomment:
  // setInterval(loadAnalytics, 30000);
</script>
</body>
</html>